<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coyahue Helpdesk · Diagramas</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            color-scheme: light;
            font-size: 16px;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            min-height: 100vh;
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background: linear-gradient(180deg, #f3f4f6 0%, #e5e7eb 40%, #eef2ff 100%);
            color: #0f172a;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: clamp(1.5rem, 3vw, 3rem);
        }

        .hero {
            position: relative;
            z-index: 1;
            width: min(960px, 100%);
            background: rgba(255, 255, 255, 0.86);
            border: 1px solid rgba(148, 163, 184, 0.45);
            border-radius: 32px;
            padding: clamp(2.5rem, 5vw, 3.75rem);
            box-shadow: 0 35px 80px rgba(15, 23, 42, 0.12);
            text-align: center;
            backdrop-filter: blur(12px);
        }

        h1 {
            font-size: clamp(2.4rem, 3.4vw, 3.2rem);
            margin: 0 0 1rem;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            color: #1e3a8a;
        }

        .buttons {
            display: grid;
            gap: 1.25rem;
            grid-template-columns: repeat(3, minmax(0, 1fr));
        }

        .diagram-button {
            appearance: none;
            border: none;
            border-radius: 18px;
            padding: 1.2rem 1.6rem;
            font-weight: 600;
            letter-spacing: 0.05em;
            background: linear-gradient(135deg, #2563eb, #7c3aed);
            color: #f8fafc;
            cursor: pointer;
            box-shadow: 0 18px 36px rgba(79, 70, 229, 0.25);
            transition: transform 0.25s ease, box-shadow 0.25s ease;
        }

        .diagram-button:hover {
            transform: translateY(-4px);
            box-shadow: 0 24px 46px rgba(79, 70, 229, 0.3);
        }

        .panels {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.45);
            backdrop-filter: blur(14px);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2.5rem 2rem;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.35s ease;
            z-index: 20;
            overflow: auto;
        }

        .panels.visible {
            opacity: 1;
            pointer-events: auto;
        }

        .panel {
            width: min(1500px, 100vw - 64px);
            max-height: calc(100vh - 96px);
            background: #f8fafc;
            border-radius: 28px;
            border: 1px solid rgba(148, 163, 184, 0.35);
            box-shadow: 0 35px 70px rgba(15, 23, 42, 0.25);
            display: none;
            flex-direction: column;
            overflow: hidden;
            transform: translateY(40px) scale(0.97);
            opacity: 0;
            transition: transform 0.35s ease, opacity 0.35s ease;
        }

        .panel.active {
            display: flex;
            transform: translateY(0) scale(1);
            opacity: 1;
        }

        .panel.focus-mode {
            width: min(1740px, 100vw - 40px);
            max-height: calc(100vh - 48px);
        }

        .panel-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1.5rem 2rem;
            border-bottom: 1px solid rgba(148, 163, 184, 0.35);
            background: rgba(226, 232, 240, 0.6);
        }

        .panel-header h2 {
            margin: 0;
            font-size: 1.8rem;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            color: #1f2937;
        }

        .panel-actions {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .toggle-bar {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 0.75rem;
        }

        .toggle {
            display: inline-flex;
            align-items: center;
            gap: 0.45rem;
            padding: 0.45rem 0.9rem;
            border-radius: 999px;
            border: 1px solid rgba(148, 163, 184, 0.5);
            background: rgba(248, 250, 252, 0.85);
            font-size: 0.82rem;
            color: #1f2937;
        }

        .toggle input {
            accent-color: #2563eb;
            width: 16px;
            height: 16px;
        }

        .panel-body {
            flex: 1;
            min-height: 0;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            padding: 1.5rem 1.75rem 1.75rem;
        }

        .focus-button,
        .back-button {
            border: 1px solid rgba(148, 163, 184, 0.6);
            border-radius: 999px;
            padding: 0.55rem 1.35rem;
            background: #fff;
            color: #1f2937;
            font-weight: 500;
            letter-spacing: 0.04em;
            cursor: pointer;
            transition: background 0.25s ease, color 0.25s ease, box-shadow 0.25s ease;
        }

        .focus-button:hover,
        .back-button:hover {
            background: #2563eb;
            color: #fff;
            box-shadow: 0 10px 24px rgba(37, 99, 235, 0.25);
        }

        .focus-button.active {
            background: #1e40af;
            color: #f8fafc;
        }

        .diagram-wrapper,
        .der-wrapper {
            position: relative;
            border: 1px solid rgba(148, 163, 184, 0.35);
            border-radius: 22px;
            background: linear-gradient(180deg, #ffffff 0%, #f5f7fa 100%);
            padding: 1.25rem;
            overflow: auto;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .diagram-wrapper svg,
        .der-wrapper svg {
            width: 100%;
            height: auto;
            flex: 1;
        }


        .hidden {
            display: none !important;
        }

        .legend {
            margin-top: auto;
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            font-size: 0.85rem;
            color: #475569;
        }

        .legend span::before {
            content: "";
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 3px;
            margin-right: 0.5rem;
        }

        .legend .public::before { background: #bfdbfe; }
        .legend .private::before { background: #bbf7d0; }
        .legend .security::before { background: #fde68a; }
        .legend .data::before { background: #c7d2fe; }

        svg text {
            font-family: 'Inter', sans-serif;
            font-size: 16px;
        }

        .entity-header {
            font-weight: 600;
            fill: #0f172a;
        }

        .entity-attr {
            fill: #1f2937;
            font-size: 15px;
        }

        .deployment-node rect,
        .deployment-node ellipse,
        .deployment-node path,
        .deployment-node polygon {
            transition: filter 0.3s ease, opacity 0.3s ease;
        }

        .deployment-link path,
        .deployment-link text {
            transition: opacity 0.3s ease;
        }

        .deployment-link path {
            stroke: #2563eb;
            stroke-width: 3;
            fill: none;
            stroke-linecap: round;
            marker-end: url(#deployment-arrow);
        }

        .deployment-link text {
            font-size: 14px;
            fill: #1e3a8a;
        }

        .link-label {
            fill: #0f172a;
            font-size: 14px;
            font-weight: 600;
        }

        .deployment-link.planned path {
            stroke: #9ca3af;
            stroke-dasharray: 10 8;
            marker-end: url(#deployment-arrow-muted);
        }

        .deployment-node .badge {
            font-size: 12px;
            fill: #1f2937;
        }

        .planned {
            opacity: 0.35;
        }

        .planned.active-planned {
            opacity: 0.65;
        }

        .deployment-node.active {
            filter: drop-shadow(0 0 16px rgba(37, 99, 235, 0.35));
        }

        .deployment-node.dimmed,
        .deployment-link.dimmed {
            opacity: 0.4;
        }


        .usecase-shell {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            height: 100%;
        }

        .usecase-controls {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .actor-filter-btn {
            transition: all 0.2s ease;
        }

        .actor-filter-btn.is-active {
            background: linear-gradient(135deg, #2563eb, #7c3aed);
            color: #f8fafc;
            border-color: transparent;
            box-shadow: 0 15px 30px rgba(79, 70, 229, 0.25);
        }

        .info-toggle-btn {
            transition: all 0.2s ease;
        }

        .info-toggle-btn.is-active {
            background: #1d4ed8;
            color: #f8fafc;
            border-color: transparent;
            box-shadow: 0 10px 22px rgba(37, 99, 235, 0.25);
        }

        .usecase-stage {
            position: relative;
            border-radius: 24px;
            border: 1px solid rgba(148, 163, 184, 0.35);
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.95) 0%, rgba(241, 245, 249, 0.9) 100%);
            box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.6);
            padding: 1.25rem;
            overflow: hidden;
        }

        .usecase-stage::after {
            content: "";
            position: absolute;
            inset: 1.25rem;
            border-radius: 18px;
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.05) 0%, rgba(99, 102, 241, 0.08) 100%);
            pointer-events: none;
        }

        #usecase-canvas {
            width: 100%;
            height: auto;
            position: relative;
            z-index: 1;
        }

        .uc-node {
            cursor: pointer;
            transition: opacity 0.25s ease;
        }

        .uc-node:focus {
            outline: none;
        }

        .uc-node .uc-halo {
            fill: none;
            stroke-width: 8;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.25s ease;
        }

        .uc-node.actor-node .uc-halo {
            stroke: rgba(14, 165, 233, 0.75);
        }

        .uc-node.usecase-node .uc-halo {
            stroke: rgba(99, 102, 241, 0.85);
        }

        .uc-node.is-highlighted .uc-halo,
        .uc-node.is-focused .uc-halo,
        .uc-node.is-selected .uc-halo {
            opacity: 0.85;
        }

        .uc-label {
            font-size: 16px;
            font-weight: 600;
            fill: #0f172a;
        }

        .uc-label-sub {
            font-size: 13px;
            fill: #475569;
        }

        .uc-edge {
            fill: none;
            stroke-linecap: round;
            stroke-linejoin: round;
            transition: opacity 0.25s ease, stroke-width 0.2s ease;
        }

        .uc-edge.actor-edge {
            stroke: #2563eb;
            stroke-width: 3;
            marker-end: url(#arrow-actor);
        }

        .uc-edge.include-edge {
            stroke: #0ea5e9;
            stroke-width: 3;
            stroke-dasharray: 10 6;
            marker-end: url(#arrow-include);
        }

        .uc-edge.exclude-edge {
            stroke: #dc2626;
            stroke-width: 3;
            stroke-dasharray: 6 6;
            marker-end: url(#arrow-exclude);
        }

        .uc-edge.is-highlighted {
            stroke-width: 3.6;
        }

        .usecase-legend {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            font-size: 0.85rem;
            color: #475569;
        }

        .usecase-legend span::before {
            content: "";
            display: inline-block;
            width: 14px;
            height: 14px;
            border-radius: 4px;
            margin-right: 0.5rem;
        }

        .legend-actor::before { background: rgba(37, 99, 235, 0.6); }
        .legend-include::before { background: rgba(14, 165, 233, 0.6); }
        .legend-exclude::before { background: rgba(220, 38, 38, 0.6); }

        .usecase-sidepanel {
            background: rgba(255, 255, 255, 0.96);
            border: 1px solid rgba(148, 163, 184, 0.35);
            border-radius: 20px;
            box-shadow: 0 24px 60px rgba(15, 23, 42, 0.12);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .usecase-sidepanel h3 {
            font-size: 1.15rem;
            font-weight: 600;
            color: #1f2937;
        }

        .usecase-sidepanel table {
            width: 100%;
            border-collapse: collapse;
        }

        .usecase-sidepanel th,
        .usecase-sidepanel td {
            text-align: left;
            font-size: 0.9rem;
            padding: 0.45rem 0.25rem;
            color: #1f2937;
        }

        .usecase-sidepanel tbody tr:nth-child(even) {
            background: rgba(226, 232, 240, 0.35);
        }

        .panel.focus-mode[data-view="usecases"] .panel-body {
            padding: 0;
        }

        .panel.focus-mode[data-view="usecases"] .panel-header,
        .panel.focus-mode[data-view="usecases"] .usecase-controls,
        .panel.focus-mode[data-view="usecases"] .usecase-sidepanel {
            display: none;
        }

        .panel.focus-mode[data-view="usecases"] .usecase-stage {
            border: none;
            border-radius: 0;
            padding: 0;
        }

        .note {
            fill: #475569;
            font-size: 13px;
        }

        .der-wrapper svg rect {
            fill: #f8fafc;
            stroke: #cbd5f5;
            stroke-width: 2;
            rx: 18;
        }

        .entity-badges {
            fill: #1f2937;
            font-size: 13px;
            font-weight: 600;
        }

        .entity-badges {
            font-size: 11px;
            fill: rgba(248, 250, 252, 0.85);
            letter-spacing: 0.14em;
            text-transform: uppercase;
        }

        .relationship-line {
            stroke: #1d4ed8;
            stroke-width: 2.6;
            fill: none;
            marker-end: url(#der-arrow);
            transition: opacity 0.3s ease;
        }

        .relationship-line.dimmed,
        .entity.dimmed {
            opacity: 0.4;
        }

        .cardinality {
            fill: #1f2937;
            font-size: 13px;
            font-weight: 600;
        }

        .cardinality,
        .relationship-label {
            fill: #334155;
            font-size: 13px;
        }

        .entity.dimmed { opacity: 0.4; }
        .entity.active { filter: drop-shadow(0 0 20px rgba(129, 140, 248, 0.75)); }

        .der-note {
            fill: #475569;
            font-size: 13px;
        }

        @media (max-width: 1024px) {
            body { padding: 1.5rem; }
            .hero { padding: 2.25rem 1.75rem; }
            .buttons { grid-template-columns: 1fr; }
            .panel {
                width: min(100%, 100vw - 32px);
                height: min(100%, 100vh - 32px);
            }
            .panel-body {
                grid-template-columns: 1fr;
            }
            .side-panel {
                order: -1;
                height: 240px;
                overflow-y: auto;
            }
        }
    </style>
</head>
<body>
    <section class="hero">
        <h1>Coyahue Helpdesk</h1>
        <div class="buttons">
            <button class="diagram-button" data-panel="deployment">Vista de Despliegue</button>
            <button class="diagram-button" data-panel="usecases">Casos de Uso</button>
            <button class="diagram-button" data-panel="der">Modelo de Datos</button>
        </div>
    </section>

    <div class="panels" id="panels">
        <!-- VISTA DE DESPLIEGUE -->
        <section class="panel" id="deployment" data-view="deployment">
            <div class="panel-header">
                <h2>Arquitectura de Despliegue</h2>
                <div class="panel-actions">
                    <div class="toggle-bar">
                        <label class="toggle"><input type="checkbox" data-toggle="igw"> Mostrar IGW</label>
                        <label class="toggle"><input type="checkbox" data-toggle="nat"> Mostrar NAT</label>
                        <label class="toggle"><input type="checkbox" data-toggle="s3"> Mostrar S3</label>
                        <label class="toggle"><input type="checkbox" data-toggle="waf"> Mostrar WAF/ALB</label>
                    </div>
                    <button class="focus-button" data-focus>Ampliar diagrama</button>
                    <button class="back-button" data-close>Volver</button>
                </div>
            </div>
            <div class="panel-body">
                <div class="diagram-wrapper">
                    <svg id="deployment-svg" viewBox="0 0 1700 920" role="img" aria-labelledby="deploymentTitle deploymentDesc" preserveAspectRatio="xMidYMid meet">
                        <title id="deploymentTitle">Despliegue Coyahue Helpdesk en AWS</title>
                        <desc id="deploymentDesc">Topología con cliente, internet, VPC en AWS, EC2 con Nginx, Gunicorn y Django, almacenamiento local y PostgreSQL en subred privada.</desc>
                        <defs>
                            <marker id="deployment-arrow" markerWidth="14" markerHeight="14" refX="10" refY="7" orient="auto" markerUnits="strokeWidth">
                                <polygon points="0 0, 14 7, 0 14" fill="#2563eb"></polygon>
                            </marker>
                            <marker id="deployment-arrow-muted" markerWidth="14" markerHeight="14" refX="10" refY="7" orient="auto" markerUnits="strokeWidth">
                                <polygon points="0 0, 14 7, 0 14" fill="#9ca3af"></polygon>
                            </marker>
                            <marker id="arrow-dashed" markerWidth="10" markerHeight="10" refX="8" refY="5" orient="auto" markerUnits="strokeWidth">
                                <polygon points="0 0, 10 5, 0 10" fill="rgba(148, 163, 184, 0.7)"></polygon>
                            </marker>
                        </defs>
                        <g data-node="Cliente" class="deployment-node">
                            <rect x="80" y="360" width="200" height="200" rx="22" fill="#bfdbfe" stroke="#60a5fa" stroke-width="2.4"></rect>
                            <text x="180" y="412" text-anchor="middle" class="entity-header">Cliente</text>
                            <text x="180" y="442" text-anchor="middle" class="entity-attr">Navegador web</text>
                            <text x="180" y="470" text-anchor="middle" class="entity-attr">TLS + Autenticación</text>
                        </g>

                        <g data-node="Internet" class="deployment-node">
                            <path d="M340 320 C330 280 390 250 430 265 C450 225 530 225 550 265 C600 255 640 290 630 330 C670 350 660 400 610 410 C590 450 510 460 480 430 C430 450 370 430 380 380 C340 372 338 340 340 320 Z" fill="#e0e7ff" stroke="#6366f1" stroke-width="2.4"></path>
                            <text x="495" y="318" text-anchor="middle" class="entity-header">Internet</text>
                            <text x="495" y="348" text-anchor="middle" class="entity-attr">Acceso público</text>
                        </g>

                        <g data-node="IGW" class="deployment-node planned hidden" data-toggle-group="igw">
                            <polygon points="820,240 880,240 910,280 880,320 820,320 790,280" fill="#e5e7eb" stroke="#94a3b8" stroke-width="2"></polygon>
                            <text x="825" y="272" text-anchor="middle" class="entity-attr">Internet Gateway</text>
                            <text x="825" y="296" text-anchor="middle" class="badge">Por implementar</text>
                            <title>Se agregará a la tabla de rutas de la subred pública.</title>
                        </g>

                        <g data-node="AWS VPC" class="deployment-node">
                            <rect x="620" y="150" width="900" height="540" rx="28" fill="rgba(191, 219, 254, 0.25)" stroke="#38bdf8" stroke-width="2.6"></rect>
                            <text x="1480" y="190" text-anchor="end" class="entity-header">AWS VPC</text>
                        </g>

                        <g data-node="Subred pública" class="deployment-node">
                            <rect x="660" y="210" width="440" height="460" rx="24" fill="rgba(187, 247, 208, 0.6)" stroke="#4ade80" stroke-width="2"></rect>
                            <text x="880" y="260" text-anchor="middle" class="entity-header">Subred pública</text>
                        </g>

                        <g data-node="Subred privada" class="deployment-node">
                            <rect x="1140" y="210" width="320" height="460" rx="24" fill="rgba(191, 219, 254, 0.55)" stroke="#60a5fa" stroke-width="2"></rect>
                            <text x="1300" y="260" text-anchor="middle" class="entity-header">Subred privada</text>
                        </g>

                        <g data-node="Entrada VPC" class="deployment-node">
                            <rect x="700" y="320" width="200" height="200" rx="20" fill="#bbf7d0" stroke="#22c55e" stroke-width="2.4"></rect>
                            <text x="800" y="370" text-anchor="middle" class="entity-header">Entrada VPC</text>
                            <text x="800" y="402" text-anchor="middle" class="entity-attr">Security Group</text>
                            <text x="800" y="434" text-anchor="middle" class="entity-attr">HTTPS 443 · Egress controlado</text>
                        </g>

                        <g data-node="WAF/ALB" class="deployment-node planned hidden" data-toggle-group="waf">
                            <rect x="920" y="340" width="120" height="180" rx="20" fill="#f8fafc" stroke="#d1d5db" stroke-width="2.4"></rect>
                            <text x="980" y="408" text-anchor="middle" class="entity-attr">WAF / ALB</text>
                            <text x="980" y="438" text-anchor="middle" class="badge">Por implementar</text>
                            <title>Seguridad perimetral y balanceo de carga.</title>
                        </g>

                        <g data-node="NAT Gateway" class="deployment-node planned hidden" data-toggle-group="nat">
                            <rect x="1180" y="230" width="160" height="60" rx="14" fill="#f1f5f9" stroke="#94a3b8" stroke-width="2"></rect>
                            <text x="1260" y="262" text-anchor="middle" class="entity-attr">NAT Gateway</text>
                            <text x="1260" y="288" text-anchor="middle" class="badge">Por implementar</text>
                            <title>Para actualizaciones desde la subred privada sin exponer la base de datos.</title>
                        </g>

                        <g data-node="EC2 App" class="deployment-node">
                            <rect x="980" y="320" width="280" height="300" rx="22" fill="#dbeafe" stroke="#60a5fa" stroke-width="2.4"></rect>
                            <line x1="980" y1="380" x2="1260" y2="380" stroke="#94a3b8" stroke-width="1.5"></line>
                            <line x1="980" y1="440" x2="1260" y2="440" stroke="#94a3b8" stroke-width="1.5"></line>
                            <text x="1120" y="350" text-anchor="middle" class="entity-header">EC2 App</text>
                            <text x="1120" y="372" text-anchor="middle" class="entity-attr">Nginx · HTTPS (443)</text>
                            <text x="1120" y="432" text-anchor="middle" class="entity-attr">Gunicorn</text>
                            <text x="1120" y="492" text-anchor="middle" class="entity-attr">Django + DRF</text>
                        </g>

                        <g data-node="/media" class="deployment-node">
                            <rect x="1020" y="640" width="120" height="90" rx="16" fill="#ede9fe" stroke="#a855f7" stroke-width="1.8"></rect>
                            <text x="1080" y="680" text-anchor="middle" class="entity-attr">/media</text>
                            <text x="1080" y="706" text-anchor="middle" class="entity-attr">Adjuntos</text>
                        </g>

                        <g data-node="Logs" class="deployment-node">
                            <rect x="1150" y="640" width="120" height="90" rx="16" fill="#ede9fe" stroke="#a855f7" stroke-width="1.8"></rect>
                            <text x="1210" y="680" text-anchor="middle" class="entity-attr">Logs</text>
                            <text x="1210" y="706" text-anchor="middle" class="entity-attr">Aplicación</text>
                        </g>

                        <g data-node="S3" class="deployment-node planned hidden" data-toggle-group="s3">
                            <rect x="1280" y="620" width="200" height="120" rx="20" fill="#f9fafb" stroke="#cbd5f5" stroke-width="2"></rect>
                            <text x="1380" y="668" text-anchor="middle" class="entity-attr">S3 (adjuntos)</text>
                            <text x="1380" y="698" text-anchor="middle" class="badge">Por implementar</text>
                            <title>Migración prevista de /media a S3 mediante django-storages.</title>
                        </g>

                        <g data-node="PostgreSQL" class="deployment-node">
                            <ellipse cx="1300" cy="420" rx="120" ry="65" fill="#bae6fd" stroke="#0ea5e9" stroke-width="2.4"></ellipse>
                            <text x="1300" y="410" text-anchor="middle" class="entity-header">PostgreSQL</text>
                            <text x="1300" y="438" text-anchor="middle" class="entity-attr">Puerto 5432</text>
                        </g>

                        <g data-edge="Cliente-Internet" class="deployment-link" data-source="Cliente" data-target="Internet">
                            <path d="M280 460 H340"></path>
                        </g>

                        <g data-edge="Internet-Entrada" class="deployment-link" data-source="Internet" data-target="Entrada VPC">
                            <path d="M560 420 H700"></path>
                        </g>

                        <g data-edge="Entrada-WAF" class="deployment-link planned hidden" data-toggle-group="waf" data-source="Entrada VPC" data-target="WAF/ALB">
                            <path d="M900 420 H920"></path>
                        </g>

                        <g data-edge="WAF-EC2" class="deployment-link planned hidden" data-toggle-group="waf" data-source="WAF/ALB" data-target="EC2 App">
                            <path d="M1040 420 H1120"></path>
                        </g>

                        <g data-edge="Entrada-EC2" class="deployment-link" data-source="Entrada VPC" data-target="EC2 App">
                            <path d="M900 420 H980"></path>
                        </g>

                        <g data-edge="EC2-Postgres" class="deployment-link" data-source="EC2 App" data-target="PostgreSQL">
                            <path d="M1260 460 H1300"></path>
                            <text x="1280" y="380" class="link-label">Tráfico interno VPC</text>
                        </g>

                        <g data-edge="EC2-media" class="deployment-link" data-source="EC2 App" data-target="/media">
                            <path d="M1120 620 V640"></path>
                        </g>

                        <g data-edge="EC2-logs" class="deployment-link" data-source="EC2 App" data-target="Logs">
                            <path d="M1250 620 V640"></path>
                        </g>

                        <g data-edge="Postgres-EC2" class="deployment-link" data-source="PostgreSQL" data-target="EC2 App">
                            <path d="M1380 380 H1260"></path>
                        </g>

                        <g data-edge="NAT-Privada" class="deployment-link planned hidden" data-toggle-group="nat" data-source="NAT Gateway" data-target="Subred privada">
                            <path d="M1260 230 V210 H1140"></path>
                            <text x="1180" y="198" class="link-label">Salida controlada</text>
                        </g>

                        <g data-edge="Privada-NAT" class="deployment-link planned hidden" data-toggle-group="nat" data-source="Subred privada" data-target="NAT Gateway">
                            <path d="M1140 210 H1260 V230"></path>
                        </g>

                        <g data-edge="Django-S3" class="deployment-link planned hidden" data-toggle-group="s3" data-source="EC2 App" data-target="S3">
                            <path d="M1260 580 V620 H1280"></path>
                        </g>

                        <g data-edge="Internet-IGW" class="deployment-link planned hidden" data-toggle-group="igw" data-source="Internet" data-target="IGW">
                            <path d="M560 300 H820"></path>
                        </g>

                        <g data-edge="IGW-Entrada" class="deployment-link planned hidden" data-toggle-group="igw" data-source="IGW" data-target="Entrada VPC">
                            <path d="M880 280 H860 V320"></path>
                        </g>

                        <g data-edge="Internet-WAF" class="deployment-link planned hidden" data-toggle-group="waf" data-source="Internet" data-target="WAF/ALB">
                            <path d="M560 420 H920"></path>
                        </g>
                    </svg>
                    <div class="legend">
                        <span class="public">Subred pública · EC2 · Nginx/Gunicorn</span>
                        <span class="private">Subred privada · PostgreSQL</span>
                        <span class="security">TLS · Seguridad</span>
                        <span class="data">/media · Logs</span>
                    </div>
                </div>
            </div>
        </section>
        <!-- VISTA CASOS DE USO -->
        <section class="panel" id="usecases" data-view="usecases">
            <div class="panel-header">
                <h2>Casos de Uso</h2>
                <div class="panel-actions">
                    <button class="focus-button" data-focus>Ampliar diagrama</button>
                    <button class="back-button" data-close>Volver</button>
                </div>
            </div>
            <div class="panel-body">
                <div class="usecase-shell">
                    <div class="usecase-controls">
                        <div class="flex flex-wrap items-center gap-3">
                            <span class="text-sm font-semibold uppercase tracking-wide text-slate-500">Actor</span>
                            <div class="flex flex-wrap gap-2">
                                <button type="button" class="actor-filter-btn is-active border border-slate-300/80 text-sm font-medium px-4 py-2 rounded-full bg-white/80 text-slate-700" data-actor-filter="Todos">Todos</button>
                                <button type="button" class="actor-filter-btn border border-slate-300/80 text-sm font-medium px-4 py-2 rounded-full bg-white/80 text-slate-700" data-actor-filter="actor-sol">Solicitante</button>
                                <button type="button" class="actor-filter-btn border border-slate-300/80 text-sm font-medium px-4 py-2 rounded-full bg-white/80 text-slate-700" data-actor-filter="actor-tec">Técnico</button>
                                <button type="button" class="actor-filter-btn border border-slate-300/80 text-sm font-medium px-4 py-2 rounded-full bg-white/80 text-slate-700" data-actor-filter="actor-adm">Administrador</button>
                            </div>
                        </div>
                        <div class="usecase-legend">
                            <span class="legend-actor">Relación actor</span>
                            <span class="legend-include">include</span>
                            <span class="legend-exclude">exclude</span>
                        </div>
                    </div>
                    <div class="flex flex-col xl:flex-row gap-6 h-full">
                        <div class="flex-1 flex">
                            <div class="usecase-stage w-full h-full">
                                <svg id="usecase-canvas" viewBox="0 0 1200 1000" role="img" aria-labelledby="usecaseTitle usecaseDesc" tabindex="0">
                                    <title id="usecaseTitle">Casos de uso del sistema de tickets</title>
                                    <desc id="usecaseDesc">Diagrama interactivo con actores y casos de uso del helpdesk Coyahue.</desc>
                                    <defs>
                                        <marker id="arrow-actor" markerWidth="12" markerHeight="12" refX="10" refY="6" orient="auto" markerUnits="strokeWidth">
                                            <path d="M0,0 L12,6 L0,12 Z" fill="#2563eb"></path>
                                        </marker>
                                        <marker id="arrow-include" markerWidth="12" markerHeight="12" refX="10" refY="6" orient="auto" markerUnits="strokeWidth">
                                            <path d="M0,0 L12,6 L0,12 Z" fill="#0ea5e9"></path>
                                        </marker>
                                        <marker id="arrow-exclude" markerWidth="12" markerHeight="12" refX="10" refY="6" orient="auto" markerUnits="strokeWidth">
                                            <path d="M0,0 L12,6 L0,12 Z" fill="#dc2626"></path>
                                        </marker>
                                    </defs>
                                    <g id="graph">
                                        <g id="canvas-background">
                                            <rect x="380" y="80" width="440" height="860" rx="28" ry="28" fill="rgba(219,234,254,0.55)" stroke="#1d4ed8" stroke-width="3"></rect>
                                            <text x="600" y="110" text-anchor="middle" font-size="20" font-weight="700" fill="#1d4ed8">Sistema de Tickets</text>
                                        </g>
                                        <g id="edges"></g>
                                        <g id="nodes"></g>
                                    </g>
                                </svg>
                            </div>
                        </div>
                        <aside class="usecase-sidepanel w-full xl:w-96">
                            <div class="flex items-center justify-between px-5 py-4 border-b border-slate-200/70 bg-slate-50/70">
                                <div>
                                    <h3 id="usecase-info-title">Selecciona un nodo</h3>
                                    <p class="text-sm text-slate-500" id="usecase-info-subtitle">Explora actores y casos para ver detalles.</p>
                                </div>
                                <div class="inline-flex overflow-hidden rounded-full border border-slate-300/70 bg-white text-sm font-medium">
                                    <button type="button" class="info-toggle-btn is-active px-3 py-1.5" data-info-mode="explanation">Explicación</button>
                                    <button type="button" class="info-toggle-btn px-3 py-1.5" data-info-mode="relations">Relaciones</button>
                                </div>
                            </div>
                            <div class="flex-1 overflow-y-auto px-5 py-4 space-y-4" id="usecase-info-content">
                                <p class="text-sm leading-relaxed text-slate-600" id="usecase-explanation">Selecciona un actor o caso para ver su propósito dentro del sistema.</p>
                                <div id="usecase-relations-wrapper" class="hidden">
                                    <table>
                                        <thead>
                                            <tr class="text-xs uppercase tracking-wide text-slate-500">
                                                <th class="py-2">Destino</th>
                                                <th class="py-2">Tipo</th>
                                                <th class="py-2">Dirección</th>
                                            </tr>
                                        </thead>
                                        <tbody id="usecase-relations-body"></tbody>
                                    </table>
                                </div>
                            </div>
                        </aside>
                    </div>
                </div>
            </div>
        </section>
        <!-- VISTA DER -->
        <section class="panel" id="der" data-view="der">
            <div class="panel-header">
                <h2>Diagrama Entidad-Relación</h2>
                <div class="panel-actions">
                    <button class="focus-button" data-focus>Ampliar diagrama</button>
                    <button class="back-button" data-close>Volver</button>
                </div>
            </div>
            <div class="panel-body">
                <div class="der-wrapper">
                    <svg id="der-svg" viewBox="0 0 1760 1120" role="img" aria-labelledby="derTitle derDesc" preserveAspectRatio="xMidYMid meet">
                        <title id="derTitle">Modelo de datos Coyahue Helpdesk</title>
                        <desc id="derDesc">Entidades auth_user, Category, Subcategory, Ticket, Priority, Area y los registros relacionados de comentarios, adjuntos, asignaciones y auditoría.</desc>
                        <defs>
                            <marker id="der-arrow" markerWidth="10" markerHeight="10" refX="8" refY="5" orient="auto" markerUnits="strokeWidth">
                                <polygon points="0 0, 10 5, 0 10" fill="#2563eb"></polygon>
                            </marker>
                        </defs>

                        <g data-node="auth_user" class="entity" transform="translate(80,140)">
                            <rect width="320" height="220"></rect>
                            <text x="160" y="32" text-anchor="middle" class="entity-header">auth_user</text>
                            <text x="20" y="70" class="entity-badges">PK</text>
                            <text x="20" y="100" class="entity-attr">• id (PK)</text>
                            <text x="20" y="120" class="entity-attr">• username</text>
                            <text x="20" y="140" class="entity-attr">• password (hash)</text>
                            <text x="20" y="160" class="entity-attr">• email</text>
                            <text x="20" y="180" class="entity-attr">• is_active · is_staff</text>
                        </g>

                        <g data-node="Category" class="entity" transform="translate(420,140)">
                            <rect width="300" height="220"></rect>
                            <text x="150" y="32" text-anchor="middle" class="entity-header">Category</text>
                            <text x="20" y="70" class="entity-badges">UNIQUE</text>
                            <text x="20" y="100" class="entity-attr">• id (PK)</text>
                            <text x="20" y="120" class="entity-attr">• name</text>
                            <text x="20" y="140" class="entity-attr">• description</text>
                            <text x="20" y="160" class="entity-attr">• is_active</text>
                            <text x="20" y="180" class="entity-attr">Nota: nombres normalizados en MAYÚSCULAS</text>
                        </g>

                        <g data-node="Subcategory" class="entity" transform="translate(760,140)">
                            <rect width="320" height="240"></rect>
                            <text x="160" y="32" text-anchor="middle" class="entity-header">Subcategory</text>
                            <text x="20" y="70" class="entity-badges">FK</text>
                            <text x="20" y="100" class="entity-attr">• id (PK)</text>
                            <text x="20" y="120" class="entity-attr">• category_id (FK)</text>
                            <text x="20" y="140" class="entity-attr">• name</text>
                            <text x="20" y="160" class="entity-attr">• description</text>
                            <text x="20" y="180" class="entity-attr">• is_active</text>
                            <text x="20" y="200" class="entity-attr">Nota: unicidad por categoría</text>
                        </g>

                        <g data-node="Ticket" class="entity" transform="translate(640,420)">
                            <rect width="340" height="380"></rect>
                            <text x="170" y="32" text-anchor="middle" class="entity-header">Ticket</text>
                            <text x="20" y="70" class="entity-badges">UNIQUE · INDEX</text>
                            <text x="20" y="100" class="entity-attr">• id (PK)</text>
                            <text x="20" y="120" class="entity-attr">• code (UNIQUE)</text>
                            <text x="20" y="140" class="entity-attr">• title · description</text>
                            <text x="20" y="160" class="entity-attr">• kind {REQUEST|INCIDENT}</text>
                            <text x="20" y="180" class="entity-attr">• status {OPEN|IN_PROGRESS|RESOLVED|CLOSED}</text>
                            <text x="20" y="200" class="entity-attr">• requester_id (FK)</text>
                            <text x="20" y="220" class="entity-attr">• assigned_to_id (FK, NULL)</text>
                            <text x="20" y="240" class="entity-attr">• category_id (FK)</text>
                            <text x="20" y="260" class="entity-attr">• subcategory_id (FK, NULL)</text>
                            <text x="20" y="280" class="entity-attr">• priority_id (FK)</text>
                            <text x="20" y="300" class="entity-attr">• area_id (FK, NULL)</text>
                            <text x="20" y="320" class="entity-attr">• created_at (INDEX) · updated_at</text>
                            <text x="20" y="340" class="entity-attr">• resolved_at? · closed_at? · cluster_id (INDEX·DEPRECATED)</text>
                        </g>

                        <g data-node="Priority" class="entity" transform="translate(1120,140)">
                            <rect width="280" height="220"></rect>
                            <text x="140" y="32" text-anchor="middle" class="entity-header">Priority</text>
                            <text x="20" y="70" class="entity-badges">UNIQUE</text>
                            <text x="20" y="100" class="entity-attr">• id (PK)</text>
                            <text x="20" y="120" class="entity-attr">• name</text>
                            <text x="20" y="140" class="entity-attr">• sla_hours</text>
                        </g>

                        <g data-node="Area" class="entity" transform="translate(1440,140)">
                            <rect width="280" height="240"></rect>
                            <text x="140" y="32" text-anchor="middle" class="entity-header">Area</text>
                            <text x="20" y="70" class="entity-badges">UNIQUE</text>
                            <text x="20" y="100" class="entity-attr">• id (PK)</text>
                            <text x="20" y="120" class="entity-attr">• name</text>
                            <text x="20" y="140" class="entity-attr">• is_active</text>
                        </g>

                        <g data-node="TicketComment" class="entity" transform="translate(300,720)">
                            <rect width="300" height="240"></rect>
                            <text x="150" y="32" text-anchor="middle" class="entity-header">TicketComment</text>
                            <text x="20" y="70" class="entity-badges">FK</text>
                            <text x="20" y="100" class="entity-attr">• id (PK)</text>
                            <text x="20" y="120" class="entity-attr">• ticket_id (FK)</text>
                            <text x="20" y="140" class="entity-attr">• author_id (FK)</text>
                            <text x="20" y="160" class="entity-attr">• body</text>
                            <text x="20" y="180" class="entity-attr">• is_internal</text>
                            <text x="20" y="200" class="entity-attr">• created_at</text>
                        </g>

                        <g data-node="TicketAttachment" class="entity" transform="translate(620,720)">
                            <rect width="300" height="240"></rect>
                            <text x="150" y="32" text-anchor="middle" class="entity-header">TicketAttachment</text>
                            <text x="20" y="70" class="entity-badges">FK</text>
                            <text x="20" y="100" class="entity-attr">• id (PK)</text>
                            <text x="20" y="120" class="entity-attr">• ticket_id (FK)</text>
                            <text x="20" y="140" class="entity-attr">• uploaded_by_id (FK)</text>
                            <text x="20" y="160" class="entity-attr">• file</text>
                            <text x="20" y="180" class="entity-attr">• content_type · size</text>
                            <text x="20" y="200" class="entity-attr">• uploaded_at</text>
                        </g>

                        <g data-node="TicketAssignment" class="entity" transform="translate(940,720)">
                            <rect width="320" height="240"></rect>
                            <text x="160" y="32" text-anchor="middle" class="entity-header">TicketAssignment</text>
                            <text x="20" y="70" class="entity-badges">FK</text>
                            <text x="20" y="100" class="entity-attr">• id (PK)</text>
                            <text x="20" y="120" class="entity-attr">• ticket_id (FK)</text>
                            <text x="20" y="140" class="entity-attr">• from_user_id (FK, NULL)</text>
                            <text x="20" y="160" class="entity-attr">• to_user_id (FK)</text>
                            <text x="20" y="180" class="entity-attr">• reason</text>
                            <text x="20" y="200" class="entity-attr">• created_at</text>
                        </g>

                        <g data-node="AuditLog" class="entity" transform="translate(1260,720)">
                            <rect width="320" height="260"></rect>
                            <text x="160" y="32" text-anchor="middle" class="entity-header">AuditLog</text>
                            <text x="20" y="70" class="entity-badges">FK</text>
                            <text x="20" y="100" class="entity-attr">• id (PK)</text>
                            <text x="20" y="120" class="entity-attr">• ticket_id (FK)</text>
                            <text x="20" y="140" class="entity-attr">• actor_id (FK, NULL)</text>
                            <text x="20" y="160" class="entity-attr">• action {CREATE|ASSIGN|UPDATE|STATUS|COMMENT|ATTACH|SLA_WARN|SLA_BREACH}</text>
                            <text x="20" y="180" class="entity-attr">• meta (JSON)</text>
                            <text x="20" y="200" class="entity-attr">• created_at</text>
                        </g>
                        <path class="relationship-line" data-edge="user-ticket" data-source="auth_user" data-target="Ticket" d="M400 250 H640 V420 H810"></path>
                        <text x="460" y="238" class="cardinality">1..N</text>
                        <text x="460" y="262" class="relationship-label">requester (CASCADE)</text>

                        <path class="relationship-line" data-edge="user-assigned" data-source="auth_user" data-target="Ticket" d="M400 280 H600 V610 H640"></path>
                        <text x="460" y="360" class="cardinality">1..N</text>
                        <text x="460" y="384" class="relationship-label">assigned_to (SET_NULL)</text>

                        <path class="relationship-line" data-edge="category-subcategory" data-source="Category" data-target="Subcategory" d="M720 220 H760"></path>
                        <text x="740" y="208" class="cardinality">1..N</text>
                        <text x="740" y="234" class="relationship-label">category (CASCADE)</text>

                        <path class="relationship-line" data-edge="category-ticket" data-source="Category" data-target="Ticket" d="M570 360 V420 H640"></path>
                        <text x="582" y="388" class="cardinality">1..N</text>
                        <text x="586" y="412" class="relationship-label">category (PROTECT)</text>

                        <path class="relationship-line" data-edge="subcategory-ticket" data-source="Subcategory" data-target="Ticket" d="M920 380 V420 H810"></path>
                        <text x="932" y="398" class="cardinality">1..N</text>
                        <text x="940" y="420" class="relationship-label">subcategory (PROTECT, opcional)</text>

                        <path class="relationship-line" data-edge="priority-ticket" data-source="Priority" data-target="Ticket" d="M1120 250 V610 H980"></path>
                        <text x="1128" y="430" class="cardinality">1..N</text>
                        <text x="1132" y="454" class="relationship-label">priority (PROTECT)</text>

                        <path class="relationship-line" data-edge="area-ticket" data-source="Area" data-target="Ticket" d="M1440 260 V610 H980"></path>
                        <text x="1450" y="430" class="cardinality">1..N</text>
                        <text x="1454" y="454" class="relationship-label">area (PROTECT, opcional)</text>

                        <path class="relationship-line" data-edge="ticket-comment" data-source="Ticket" data-target="TicketComment" d="M810 800 V880 H450 V720"></path>
                        <text x="760" y="860" class="cardinality">1..N</text>
                        <text x="680" y="884" class="relationship-label">comentarios (CASCADE)</text>

                        <path class="relationship-line" data-edge="ticket-attachment" data-source="Ticket" data-target="TicketAttachment" d="M810 800 V760 H770 V720"></path>
                        <text x="792" y="748" class="cardinality">1..N</text>
                        <text x="802" y="772" class="relationship-label">adjuntos (CASCADE)</text>

                        <path class="relationship-line" data-edge="ticket-assignment" data-source="Ticket" data-target="TicketAssignment" d="M810 800 V780 H1100 V720"></path>
                        <text x="920" y="788" class="cardinality">1..N</text>
                        <text x="930" y="812" class="relationship-label">asignaciones (CASCADE)</text>

                        <path class="relationship-line" data-edge="ticket-audit" data-source="Ticket" data-target="AuditLog" d="M810 800 V900 H1420 V720"></path>
                        <text x="1040" y="892" class="cardinality">1..N</text>
                        <text x="1050" y="916" class="relationship-label">auditoría (CASCADE)</text>

                        <path class="relationship-line" data-edge="user-comment" data-source="auth_user" data-target="TicketComment" d="M240 360 V720 H450"></path>
                        <text x="220" y="520" class="cardinality">1..N</text>
                        <text x="226" y="544" class="relationship-label">author (CASCADE)</text>

                        <path class="relationship-line" data-edge="user-attachment" data-source="auth_user" data-target="TicketAttachment" d="M260 360 V720 H770"></path>
                        <text x="300" y="640" class="cardinality">1..N</text>
                        <text x="306" y="664" class="relationship-label">uploaded_by (CASCADE)</text>

                        <path class="relationship-line" data-edge="user-assignment-from" data-source="auth_user" data-target="TicketAssignment" d="M280 360 V720 H1100"></path>
                        <text x="420" y="640" class="cardinality">1..N</text>
                        <text x="426" y="664" class="relationship-label">from_user (SET_NULL)</text>

                        <path class="relationship-line" data-edge="user-assignment-to" data-source="auth_user" data-target="TicketAssignment" d="M300 360 V760 H1260 V720"></path>
                        <text x="520" y="660" class="cardinality">1..N</text>
                        <text x="526" y="684" class="relationship-label">to_user (CASCADE)</text>

                        <path class="relationship-line" data-edge="user-audit" data-source="auth_user" data-target="AuditLog" d="M320 360 V720 H1420"></path>
                        <text x="620" y="640" class="cardinality">1..N</text>
                        <text x="626" y="664" class="relationship-label">actor (SET_NULL)</text>

                        <text x="980" y="1060" class="der-note">Ticket.code es único; created_at está indexado para reportes y ticket.cluster_id permanece por compatibilidad (deprecated).</text>
                    </svg>
                </div>
            </div>
        </section>
    </div>
    <script>
        const panels = document.getElementById('panels');
        const diagramButtons = document.querySelectorAll('.diagram-button');
        const closeButtons = document.querySelectorAll('[data-close]');
        const focusButtons = document.querySelectorAll('[data-focus]');

        let currentPanel = null;

        diagramButtons.forEach(button => {
            button.addEventListener('click', () => {
                const targetId = button.getAttribute('data-panel');
                const panel = document.getElementById(targetId);
                if (!panel) return;

                if (currentPanel && currentPanel !== panel) {
                    currentPanel.classList.remove('active', 'focus-mode');
                    currentPanel.querySelectorAll('[data-focus]').forEach(btn => btn.classList.remove('active'));
                }

                currentPanel = panel;
                panels.classList.add('visible');
                panel.classList.add('active');
            });
        });

        closeButtons.forEach(button => {
            button.addEventListener('click', () => {
                if (currentPanel) {
                    currentPanel.classList.remove('active', 'focus-mode');
                    currentPanel.querySelectorAll('[data-focus]').forEach(btn => btn.classList.remove('active'));
                    panels.classList.remove('visible');
                    currentPanel = null;
                }
            });
        });

        focusButtons.forEach(button => {
            button.addEventListener('click', () => {
                const panel = button.closest('.panel');
                panel.classList.toggle('focus-mode');
                button.classList.toggle('active');
                button.textContent = panel.classList.contains('focus-mode') ? 'Salir de foco' : 'Ampliar diagrama';
            });
        });

        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape' && currentPanel) {
                currentPanel.classList.remove('active', 'focus-mode');
                currentPanel.querySelectorAll('[data-focus]').forEach(btn => btn.classList.remove('active'));
                panels.classList.remove('visible');
                currentPanel = null;
            }
        });

        const toggleInputs = document.querySelectorAll('[data-toggle]');
        toggleInputs.forEach(input => {
            input.addEventListener('change', () => {
                const target = input.getAttribute('data-toggle');
                document.querySelectorAll(`[data-toggle-group="${target}"]`).forEach(group => {
                    group.classList.toggle('hidden', !input.checked);
                    if (input.checked) {
                        group.classList.add('active-planned');
                    } else {
                        group.classList.remove('active-planned');
                    }
                });
            });
        });

        function buildAdjacency(panel, adjacency) {
            const nodes = panel.querySelectorAll('[data-node]');
            const edges = panel.querySelectorAll('[data-source][data-target]');
            let selected = null;

            function clearHighlight() {
                nodes.forEach(n => n.classList.remove('active', 'dimmed'));
                edges.forEach(e => e.classList.remove('active', 'dimmed'));
            }

            function applyHighlight(name) {
                clearHighlight();
                if (!name) return;
                const neighbors = adjacency[name] || [];
                nodes.forEach(n => n.classList.add('dimmed'));
                edges.forEach(e => e.classList.add('dimmed'));
                panel.querySelectorAll(`[data-node="${name}"]`).forEach(n => {
                    n.classList.remove('dimmed');
                    n.classList.add('active');
                });
                neighbors.forEach(neighbor => {
                    panel.querySelectorAll(`[data-node="${neighbor}"]`).forEach(n => {
                        n.classList.remove('dimmed');
                        n.classList.add('active');
                    });
                    panel.querySelectorAll(`[data-source="${name}"][data-target="${neighbor}"]`).forEach(edge => {
                        edge.classList.remove('dimmed');
                        edge.classList.add('active');
                    });
                    panel.querySelectorAll(`[data-source="${neighbor}"][data-target="${name}"]`).forEach(edge => {
                        edge.classList.remove('dimmed');
                        edge.classList.add('active');
                    });
                });
            }

            panel.addEventListener('click', (event) => {
                if (!event.target.closest('[data-node]') && selected) {
                    selected = null;
                    clearHighlight();
                    panel.dispatchEvent(new CustomEvent('nodeCleared'));
                }
            });

            nodes.forEach(node => {
                const nodeName = node.getAttribute('data-node');
                node.addEventListener('mouseenter', () => {
                    if (selected) return;
                    applyHighlight(nodeName);
                });
                node.addEventListener('mouseleave', () => {
                    if (selected) {
                        applyHighlight(selected);
                    } else {
                        clearHighlight();
                    }
                });
                node.addEventListener('click', () => {
                    if (selected === nodeName) {
                        selected = null;
                        clearHighlight();
                        panel.dispatchEvent(new CustomEvent('nodeCleared'));
                    } else {
                        selected = nodeName;
                        applyHighlight(nodeName);
                        panel.dispatchEvent(new CustomEvent('nodeSelected', { detail: { name: nodeName } }));
                    }
                });
            });
        }

        buildAdjacency(document.getElementById('deployment'), {
            'Cliente': ['Internet'],
            'Internet': ['Cliente', 'Entrada VPC', 'IGW', 'WAF/ALB'],
            'IGW': ['Entrada VPC', 'Internet'],
            'Entrada VPC': ['Internet', 'EC2 App', 'WAF/ALB'],
            'AWS VPC': ['Subred pública', 'Subred privada'],
            'Subred pública': ['EC2 App', 'AWS VPC', 'NAT Gateway'],
            'Subred privada': ['PostgreSQL', 'AWS VPC', 'NAT Gateway'],
            'NAT Gateway': ['Subred privada'],
            'EC2 App': ['Entrada VPC', 'PostgreSQL', '/media', 'Logs', 'S3'],
            'WAF/ALB': ['Internet', 'Entrada VPC', 'EC2 App'],
            '/media': ['EC2 App'],
            'Logs': ['EC2 App'],
            'S3': ['EC2 App'],
            'PostgreSQL': ['EC2 App', 'Subred privada']
        });

        buildAdjacency(document.getElementById('der'), {
            'auth_user': ['Ticket', 'TicketComment', 'TicketAttachment', 'TicketAssignment', 'AuditLog'],
            'Category': ['Subcategory', 'Ticket'],
            'Subcategory': ['Category', 'Ticket'],
            'Ticket': ['auth_user', 'Category', 'Subcategory', 'Priority', 'Area', 'TicketComment', 'TicketAttachment', 'TicketAssignment', 'AuditLog'],
            'Priority': ['Ticket'],
            'Area': ['Ticket'],
            'TicketComment': ['Ticket', 'auth_user'],
            'TicketAttachment': ['Ticket', 'auth_user'],
            'TicketAssignment': ['Ticket', 'auth_user'],
            'AuditLog': ['Ticket', 'auth_user']
        });


        const usecaseCanvas = document.getElementById('usecase-canvas');
        const edgesLayer = usecaseCanvas.querySelector('#edges');
        const nodesLayer = usecaseCanvas.querySelector('#nodes');
        const actorFilterButtons = Array.from(document.querySelectorAll('[data-actor-filter]'));
        const infoToggleButtons = Array.from(document.querySelectorAll('[data-info-mode]'));
        const infoTitle = document.getElementById('usecase-info-title');
        const infoSubtitle = document.getElementById('usecase-info-subtitle');
        const infoExplanation = document.getElementById('usecase-explanation');
        const relationsWrapper = document.getElementById('usecase-relations-wrapper');
        const relationsBody = document.getElementById('usecase-relations-body');

        const createSvgElement = (tag) => document.createElementNS('http://www.w3.org/2000/svg', tag);

        const usecaseModel = {
            nodes: [
                { id: 'actor-sol', type: 'actor', label: 'Solicitante', x: 80, y: 160, width: 160, height: 60, description: 'Reporta incidencias, consulta la FAQ y sigue el estado de sus tickets.' },
                { id: 'actor-tec', type: 'actor', label: 'Técnico', x: 80, y: 340, width: 160, height: 60, description: 'Atiende tickets asignados, actualiza estados y mantiene comunicación con solicitantes.' },
                { id: 'actor-adm', type: 'actor', label: 'Administrador', x: 80, y: 520, width: 160, height: 60, description: 'Administra catálogos, supervisa indicadores y vigila el registro de auditoría.' },
                { id: 'uc-login', type: 'usecase', label: 'Iniciar/Cerrar sesión', x: 400, y: 120, width: 360, height: 40, description: 'Acceso autenticado al sistema y cierre de sesión seguro.' },
                { id: 'uc-perms', type: 'usecase', label: 'Validar permisos por rol', x: 400, y: 190, width: 360, height: 40, description: 'Chequea el rol antes de permitir acciones restringidas.' },
                { id: 'uc-faq', type: 'usecase', label: 'FAQ autoservicio', x: 400, y: 260, width: 360, height: 40, description: 'Consulta respuestas frecuentes para resolver sin crear tickets.' },
                { id: 'uc-view', type: 'usecase', label: 'Ver y filtrar tickets', x: 400, y: 330, width: 360, height: 40, description: 'Listado de tickets con filtros por estado, prioridad y área.' },
                { id: 'uc-create', type: 'usecase', label: 'Crear ticket', x: 400, y: 400, width: 360, height: 40, description: 'Alta de tickets con título, tipo, categoría y subcategoría.' },
                { id: 'uc-attach', type: 'usecase', label: 'Adjuntar y comentar', x: 400, y: 470, width: 360, height: 40, description: 'Agrega archivos y comentarios en el historial del ticket.' },
                { id: 'uc-status', type: 'usecase', label: 'Cambiar estado', x: 400, y: 540, width: 360, height: 40, description: 'Transiciona entre OPEN, IN_PROGRESS, RESOLVED y CLOSED.' },
                { id: 'uc-assign', type: 'usecase', label: 'Asignar/Reasignar', x: 400, y: 610, width: 360, height: 40, description: 'Deriva tickets a técnicos, registrando responsable y motivo.' },
                { id: 'uc-kpi', type: 'usecase', label: 'Dashboard KPI', x: 400, y: 680, width: 360, height: 40, description: 'Panel de métricas operativas y alertas tempranas.' },
                { id: 'uc-export', type: 'usecase', label: 'Exportar PDF/Excel', x: 400, y: 750, width: 360, height: 40, description: 'Exporta listados según filtros activos a PDF o Excel.' },
                { id: 'uc-catalog', type: 'usecase', label: 'Gestionar catálogos', x: 400, y: 820, width: 360, height: 40, description: 'Administra categorías, subcategorías, prioridades y áreas.' },
                { id: 'uc-audit', type: 'usecase', label: 'Auditoría', x: 400, y: 890, width: 360, height: 40, description: 'Registro detallado de todas las acciones realizadas en el sistema.' }
            ],
            edges: {
                actor: [
                    { from: 'actor-sol', to: 'uc-login' },
                    { from: 'actor-sol', to: 'uc-faq' },
                    { from: 'actor-sol', to: 'uc-view' },
                    { from: 'actor-sol', to: 'uc-create' },
                    { from: 'actor-sol', to: 'uc-attach' },
                    { from: 'actor-tec', to: 'uc-login' },
                    { from: 'actor-tec', to: 'uc-view' },
                    { from: 'actor-tec', to: 'uc-attach' },
                    { from: 'actor-tec', to: 'uc-status' },
                    { from: 'actor-tec', to: 'uc-assign' },
                    { from: 'actor-tec', to: 'uc-kpi' },
                    { from: 'actor-adm', to: 'uc-login' },
                    { from: 'actor-adm', to: 'uc-view' },
                    { from: 'actor-adm', to: 'uc-assign' },
                    { from: 'actor-adm', to: 'uc-kpi' },
                    { from: 'actor-adm', to: 'uc-catalog' },
                    { from: 'actor-adm', to: 'uc-export' },
                    { from: 'actor-adm', to: 'uc-audit' }
                ],
                include: [
                    { from: 'uc-create', to: 'uc-audit' },
                    { from: 'uc-attach', to: 'uc-audit' },
                    { from: 'uc-status', to: 'uc-audit' },
                    { from: 'uc-assign', to: 'uc-audit' },
                    { from: 'uc-export', to: 'uc-view' }
                ],
                permission: [
                    { from: 'uc-view', to: 'uc-perms' },
                    { from: 'uc-create', to: 'uc-perms' },
                    { from: 'uc-attach', to: 'uc-perms' },
                    { from: 'uc-status', to: 'uc-perms' },
                    { from: 'uc-assign', to: 'uc-perms' },
                    { from: 'uc-kpi', to: 'uc-perms' },
                    { from: 'uc-export', to: 'uc-perms' },
                    { from: 'uc-catalog', to: 'uc-perms' }
                ],
                exclude: [
                    { from: 'uc-faq', to: 'uc-create' }
                ]
            }
        };

        const nodeRegistry = new Map();
        const edgeRegistry = new Map();
        const adjacency = new Map();
        const edgesByNode = new Map();
        const relations = new Map();
        const caseActors = new Map();

        const actorEdges = [];
        const includeEdges = [];
        const permissionEdges = [];
        const excludeEdges = [];

        let currentActorFilter = 'Todos';
        let selectedNodeId = null;
        let infoMode = 'explanation';
        let highlightState = null;

        function ensureStructures(id) {
            if (!adjacency.has(id)) adjacency.set(id, new Set());
            if (!edgesByNode.has(id)) edgesByNode.set(id, new Set());
            if (!relations.has(id)) relations.set(id, []);
        }

        function buildActorNode(node) {
            const group = createSvgElement('g');
            group.setAttribute('id', node.id);
            group.setAttribute('transform', `translate(${node.x}, ${node.y})`);
            group.setAttribute('tabindex', '0');
            group.setAttribute('role', 'button');
            group.setAttribute('aria-label', `${node.label}. Actor del sistema de tickets.`);
            group.dataset.type = node.type;
            group.classList.add('uc-node', 'actor-node');

            const body = createSvgElement('rect');
            body.setAttribute('width', node.width);
            body.setAttribute('height', node.height);
            body.setAttribute('rx', '18');
            body.setAttribute('ry', '18');
            body.setAttribute('fill', 'rgba(224,242,254,0.95)');
            body.setAttribute('stroke', '#0ea5e9');
            body.setAttribute('stroke-width', '2.6');
            group.appendChild(body);

            const halo = createSvgElement('rect');
            halo.setAttribute('x', '-12');
            halo.setAttribute('y', '-12');
            halo.setAttribute('width', node.width + 24);
            halo.setAttribute('height', node.height + 24);
            halo.setAttribute('rx', '28');
            halo.setAttribute('ry', '28');
            halo.setAttribute('class', 'uc-halo');
            halo.setAttribute('pointer-events', 'none');
            group.appendChild(halo);

            const icon = createSvgElement('g');
            icon.setAttribute('transform', 'translate(32,20)');
            const head = createSvgElement('circle');
            head.setAttribute('cx', '0');
            head.setAttribute('cy', '10');
            head.setAttribute('r', '10');
            head.setAttribute('fill', '#0ea5e9');
            icon.appendChild(head);
            const shoulders = createSvgElement('path');
            shoulders.setAttribute('d', 'M-18 26 C-12 14 12 14 18 26 V40 H-18 Z');
            shoulders.setAttribute('fill', '#38bdf8');
            icon.appendChild(shoulders);
            group.appendChild(icon);

            const label = createSvgElement('text');
            label.setAttribute('x', '88');
            label.setAttribute('y', node.height / 2 + 3);
            label.setAttribute('class', 'uc-label');
            label.setAttribute('dominant-baseline', 'middle');
            label.textContent = node.label;
            group.appendChild(label);

            return group;
        }

        function buildUsecaseNode(node) {
            const group = createSvgElement('g');
            group.setAttribute('id', node.id);
            group.setAttribute('transform', `translate(${node.x}, ${node.y})`);
            group.setAttribute('tabindex', '0');
            group.setAttribute('role', 'button');
            group.setAttribute('aria-label', `${node.label}. Caso de uso del sistema de tickets.`);
            group.dataset.type = node.type;
            group.classList.add('uc-node', 'usecase-node');

            const body = createSvgElement('rect');
            body.setAttribute('width', node.width);
            body.setAttribute('height', node.height);
            body.setAttribute('rx', '22');
            body.setAttribute('ry', '22');
            body.setAttribute('fill', '#f8fafc');
            body.setAttribute('stroke', '#6366f1');
            body.setAttribute('stroke-width', '2.4');
            group.appendChild(body);

            const halo = createSvgElement('rect');
            halo.setAttribute('x', '-14');
            halo.setAttribute('y', '-14');
            halo.setAttribute('width', node.width + 28);
            halo.setAttribute('height', node.height + 28);
            halo.setAttribute('rx', '30');
            halo.setAttribute('ry', '30');
            halo.setAttribute('class', 'uc-halo');
            halo.setAttribute('pointer-events', 'none');
            group.appendChild(halo);

            const label = createSvgElement('text');
            label.setAttribute('x', node.width / 2);
            label.setAttribute('y', node.height / 2 + 3);
            label.setAttribute('class', 'uc-label');
            label.setAttribute('text-anchor', 'middle');
            label.setAttribute('dominant-baseline', 'middle');
            label.textContent = node.label;
            group.appendChild(label);

            return group;
        }

        function buildActorEdgePath(fromNode, toNode) {
            const startX = fromNode.x + fromNode.width;
            const startY = fromNode.y + fromNode.height / 2;
            const corridorX = 360;
            const systemX = 380;
            const targetX = toNode.x;
            const targetY = toNode.y + toNode.height / 2;
            return `M ${startX} ${startY} H ${corridorX} V ${targetY} H ${systemX} H ${targetX}`;
        }

        function buildIncludeEdgePath(fromNode, toNode) {
            const startX = fromNode.x + fromNode.width;
            const startY = fromNode.y + fromNode.height / 2;
            const corridorX = 860;
            const targetX = toNode.x + toNode.width;
            const targetY = toNode.y + toNode.height / 2;
            return `M ${startX} ${startY} H ${corridorX} V ${targetY} H ${targetX}`;
        }

        function buildExcludeEdgePath(fromNode, toNode) {
            const startX = fromNode.x;
            const startY = fromNode.y + fromNode.height / 2;
            const targetX = toNode.x;
            const targetY = toNode.y + toNode.height / 2;
            return `M ${startX} ${startY} H 380 H 300 V ${targetY} H 380 H ${targetX}`;
        }

        function registerEdge(edge, fromNode, toNode) {
            ensureStructures(edge.from);
            ensureStructures(edge.to);

            adjacency.get(edge.from).add(edge.to);
            adjacency.get(edge.to).add(edge.from);

            edgesByNode.get(edge.from).add(edge.id);
            edgesByNode.get(edge.to).add(edge.id);

            if (edge.type === 'actor') {
                if (!caseActors.has(edge.to)) {
                    caseActors.set(edge.to, new Set());
                }
                caseActors.get(edge.to).add(edge.from);
                relations.get(edge.from).push({ target: toNode.label, type: 'caso', direction: '→' });
                relations.get(edge.to).push({ target: fromNode.label, type: 'actor', direction: '←' });
            } else if (edge.type === 'include') {
                relations.get(edge.from).push({ target: toNode.label, type: 'include', direction: '→' });
                relations.get(edge.to).push({ target: fromNode.label, type: 'include', direction: '←' });
            } else if (edge.type === 'exclude') {
                relations.get(edge.from).push({ target: toNode.label, type: 'exclude', direction: '→' });
                relations.get(edge.to).push({ target: fromNode.label, type: 'exclude', direction: '←' });
            }

            const path = createSvgElement('path');
            path.setAttribute('id', edge.id);
            path.dataset.type = 'edge';
            path.dataset.neighbors = `${edge.from},${edge.to}`;
            path.classList.add('uc-edge');

            if (edge.type === 'actor') {
                path.classList.add('actor-edge');
                path.setAttribute('d', buildActorEdgePath(fromNode, toNode));
            } else if (edge.type === 'include') {
                path.classList.add('include-edge');
                path.setAttribute('d', buildIncludeEdgePath(fromNode, toNode));
            } else {
                path.classList.add('exclude-edge');
                path.setAttribute('d', buildExcludeEdgePath(fromNode, toNode));
            }

            if (edge.hidden) {
                path.classList.add('hidden');
                path.style.opacity = 0;
            }

            edgesLayer.appendChild(path);
            edge.element = path;
            edgeRegistry.set(edge.id, edge);
        }

        usecaseModel.nodes.forEach(node => {
            ensureStructures(node.id);
            const element = node.type === 'actor' ? buildActorNode(node) : buildUsecaseNode(node);
            nodeRegistry.set(node.id, { data: node, element, baseOpacity: 1 });
            nodesLayer.appendChild(element);
        });

        usecaseModel.edges.actor.forEach(edgeData => {
            const fromNode = nodeRegistry.get(edgeData.from).data;
            const toNode = nodeRegistry.get(edgeData.to).data;
            const edge = { id: `e-${edgeData.from}-${edgeData.to}`, from: edgeData.from, to: edgeData.to, type: 'actor', element: null, baseOpacity: 1 };
            registerEdge(edge, fromNode, toNode);
            actorEdges.push(edge);
        });

        usecaseModel.edges.include.forEach(edgeData => {
            const fromNode = nodeRegistry.get(edgeData.from).data;
            const toNode = nodeRegistry.get(edgeData.to).data;
            const edge = { id: `e-${edgeData.from}-${edgeData.to}`, from: edgeData.from, to: edgeData.to, type: 'include', hidden: true, element: null, baseOpacity: 1 };
            registerEdge(edge, fromNode, toNode);
            includeEdges.push(edge);
        });

        usecaseModel.edges.permission.forEach(edgeData => {
            const fromNode = nodeRegistry.get(edgeData.from).data;
            const toNode = nodeRegistry.get(edgeData.to).data;
            const edge = { id: `e-${edgeData.from}-${edgeData.to}`, from: edgeData.from, to: edgeData.to, type: 'include', hidden: true, element: null, baseOpacity: 1 };
            registerEdge(edge, fromNode, toNode);
            permissionEdges.push(edge);
        });

        usecaseModel.edges.exclude.forEach(edgeData => {
            const fromNode = nodeRegistry.get(edgeData.from).data;
            const toNode = nodeRegistry.get(edgeData.to).data;
            const edge = { id: `e-${edgeData.from}-${edgeData.to}`, from: edgeData.from, to: edgeData.to, type: 'exclude', hidden: true, element: null, baseOpacity: 1 };
            registerEdge(edge, fromNode, toNode);
            excludeEdges.push(edge);
        });

        nodeRegistry.forEach((entry, id) => {
            const neighbors = Array.from(adjacency.get(id) || []);
            entry.element.dataset.neighbors = neighbors.join(',');
        });

        function computeHighlightState(nodeId) {
            if (!nodeId) return null;
            const nodes = new Set([nodeId]);
            const edges = new Set();
            (adjacency.get(nodeId) || new Set()).forEach(neighbor => nodes.add(neighbor));
            (edgesByNode.get(nodeId) || new Set()).forEach(edgeId => edges.add(edgeId));
            return { nodes, edges };
        }

        function applyVisualState() {
            nodeRegistry.forEach((entry, id) => {
                const element = entry.element;
                let opacity = entry.baseOpacity;
                if (highlightState) {
                    if (highlightState.nodes.has(id)) {
                        opacity = 1;
                        element.classList.add('is-highlighted');
                    } else {
                        opacity = 0.4;
                        element.classList.remove('is-highlighted');
                    }
                } else {
                    element.classList.remove('is-highlighted');
                }
                element.classList.toggle('is-selected', id === selectedNodeId);
                element.style.opacity = opacity;
            });

            edgeRegistry.forEach((edge, id) => {
                const element = edge.element;
                if (element.classList.contains('hidden')) {
                    element.style.opacity = 0;
                    element.classList.remove('is-highlighted');
                    return;
                }
                let opacity = edge.baseOpacity;
                if (highlightState) {
                    if (highlightState.edges.has(id)) {
                        opacity = 1;
                        element.classList.add('is-highlighted');
                    } else {
                        opacity = 0.4;
                        element.classList.remove('is-highlighted');
                    }
                } else {
                    element.classList.remove('is-highlighted');
                }
                element.style.opacity = opacity;
            });
        }

        function updateConditionalEdges() {
            const selectedEntry = selectedNodeId ? nodeRegistry.get(selectedNodeId) : null;
            const isCaseSelected = !!selectedEntry && selectedEntry.data.type === 'usecase';

            includeEdges.forEach(edge => {
                const shouldShow = isCaseSelected && (edge.from === selectedNodeId || edge.to === selectedNodeId);
                edge.element.classList.toggle('hidden', !shouldShow);
                if (!shouldShow) edge.element.style.opacity = 0;
            });

            permissionEdges.forEach(edge => {
                const shouldShow = isCaseSelected && edge.from === selectedNodeId;
                edge.element.classList.toggle('hidden', !shouldShow);
                if (!shouldShow) edge.element.style.opacity = 0;
            });

            excludeEdges.forEach(edge => {
                const shouldShow = selectedNodeId === edge.from;
                edge.element.classList.toggle('hidden', !shouldShow);
                if (!shouldShow) edge.element.style.opacity = 0;
            });
        }

        function updateBaseOpacities() {
            nodeRegistry.forEach((entry, id) => {
                let base = 1;
                if (currentActorFilter !== 'Todos') {
                    if (entry.data.type === 'actor') {
                        base = id === currentActorFilter ? 1 : 0.3;
                    } else if (entry.data.type === 'usecase') {
                        const actorSet = caseActors.get(id);
                        base = actorSet && actorSet.has(currentActorFilter) ? 1 : 0.3;
                    }
                }
                entry.baseOpacity = base;
            });

            edgeRegistry.forEach(edge => {
                let base = 1;
                if (edge.type === 'actor' && currentActorFilter !== 'Todos') {
                    base = edge.from === currentActorFilter ? 1 : 0.3;
                }
                edge.baseOpacity = base;
            });

            applyVisualState();
        }

        function renderInfoPanel() {
            const hasSelection = Boolean(selectedNodeId);
            if (!hasSelection) {
                infoTitle.textContent = 'Selecciona un nodo';
                infoSubtitle.textContent = 'Explora actores y casos para ver detalles.';
                infoExplanation.textContent = 'Selecciona un actor o caso para ver su propósito dentro del sistema.';
                relationsBody.innerHTML = '<tr><td colspan="3" class="py-3 text-sm text-slate-500">Selecciona un nodo para ver relaciones.</td></tr>';
            } else {
                const entry = nodeRegistry.get(selectedNodeId);
                infoTitle.textContent = entry.data.label;
                infoSubtitle.textContent = entry.data.type === 'actor' ? 'Actor del sistema' : 'Caso de uso';
                infoExplanation.textContent = entry.data.description;
                const rels = relations.get(selectedNodeId) || [];
                if (rels.length === 0) {
                    relationsBody.innerHTML = '<tr><td colspan="3" class="py-3 text-sm text-slate-500">Sin relaciones registradas.</td></tr>';
                } else {
                    relationsBody.innerHTML = rels.map(rel => `<tr><td class="py-2">${rel.target}</td><td class="py-2 capitalize">${rel.type}</td><td class="py-2">${rel.direction}</td></tr>`).join('');
                }
            }

            if (infoMode === 'explanation') {
                infoExplanation.classList.remove('hidden');
                relationsWrapper.classList.add('hidden');
            } else {
                infoExplanation.classList.add('hidden');
                relationsWrapper.classList.remove('hidden');
            }
        }

        function setInfoMode(mode) {
            infoMode = mode;
            infoToggleButtons.forEach(button => {
                const isActive = button.dataset.infoMode === mode;
                button.classList.toggle('is-active', isActive);
                button.setAttribute('aria-pressed', isActive ? 'true' : 'false');
            });
            renderInfoPanel();
        }

        function setSelectedNode(nodeId) {
            selectedNodeId = nodeId;
            updateConditionalEdges();
            highlightState = selectedNodeId ? computeHighlightState(selectedNodeId) : null;
            renderInfoPanel();
            applyVisualState();
        }

        function toggleSelection(nodeId) {
            if (selectedNodeId === nodeId) {
                setSelectedNode(null);
            } else {
                setSelectedNode(nodeId);
            }
        }

        nodeRegistry.forEach((entry, id) => {
            const element = entry.element;
            element.addEventListener('mouseenter', () => {
                if (selectedNodeId) return;
                highlightState = computeHighlightState(id);
                applyVisualState();
            });

            element.addEventListener('mouseleave', () => {
                if (selectedNodeId) {
                    highlightState = computeHighlightState(selectedNodeId);
                } else {
                    highlightState = null;
                }
                applyVisualState();
            });

            element.addEventListener('focus', () => {
                element.classList.add('is-focused');
                if (!selectedNodeId || selectedNodeId === id) {
                    highlightState = computeHighlightState(id);
                    applyVisualState();
                }
            });

            element.addEventListener('blur', () => {
                element.classList.remove('is-focused');
                if (selectedNodeId) {
                    highlightState = computeHighlightState(selectedNodeId);
                } else {
                    highlightState = null;
                }
                applyVisualState();
            });

            element.addEventListener('click', (event) => {
                event.stopPropagation();
                toggleSelection(id);
            });

            element.addEventListener('keydown', (event) => {
                if (event.key === 'Enter' || event.key === ' ') {
                    event.preventDefault();
                    toggleSelection(id);
                }
            });
        });

        actorFilterButtons.forEach(button => {
            const isActive = button.classList.contains('is-active');
            button.setAttribute('aria-pressed', isActive ? 'true' : 'false');
            button.addEventListener('click', () => {
                const filterValue = button.dataset.actorFilter;
                currentActorFilter = filterValue;
                actorFilterButtons.forEach(other => {
                    const active = other === button;
                    other.classList.toggle('is-active', active);
                    other.setAttribute('aria-pressed', active ? 'true' : 'false');
                });
                updateBaseOpacities();
            });
        });

        infoToggleButtons.forEach(button => {
            button.addEventListener('click', () => {
                setInfoMode(button.dataset.infoMode);
            });
        });

        usecaseCanvas.addEventListener('click', (event) => {
            if (event.target.closest('.uc-node')) {
                return;
            }
            setSelectedNode(null);
        });

        usecaseCanvas.addEventListener('keydown', (event) => {
            if (event.key === 'Escape') {
                setSelectedNode(null);
                usecaseCanvas.blur();
            }
        });

        setInfoMode('explanation');
        updateBaseOpacities();
        updateConditionalEdges();
        renderInfoPanel();
        applyVisualState();

    </script>
</body>
</html>
