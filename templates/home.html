<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coyahue Helpdesk · Diagramas</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            color-scheme: light;
            font-size: 16px;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            min-height: 100vh;
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background: linear-gradient(180deg, #f3f4f6 0%, #e5e7eb 40%, #eef2ff 100%);
            color: #0f172a;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: clamp(1.5rem, 3vw, 3rem);
        }

        .hero {
            position: relative;
            z-index: 1;
            width: min(960px, 100%);
            background: rgba(255, 255, 255, 0.86);
            border: 1px solid rgba(148, 163, 184, 0.45);
            border-radius: 32px;
            padding: clamp(2.5rem, 5vw, 3.75rem);
            box-shadow: 0 35px 80px rgba(15, 23, 42, 0.12);
            text-align: center;
            backdrop-filter: blur(12px);
        }

        h1 {
            font-size: clamp(2.4rem, 3.4vw, 3.2rem);
            margin: 0 0 1rem;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            color: #1e3a8a;
        }

        .buttons {
            display: grid;
            gap: 1.25rem;
            grid-template-columns: repeat(3, minmax(0, 1fr));
        }

        .diagram-button {
            appearance: none;
            border: none;
            border-radius: 18px;
            padding: 1.2rem 1.6rem;
            font-weight: 600;
            letter-spacing: 0.05em;
            background: linear-gradient(135deg, #2563eb, #7c3aed);
            color: #f8fafc;
            cursor: pointer;
            box-shadow: 0 18px 36px rgba(79, 70, 229, 0.25);
            transition: transform 0.25s ease, box-shadow 0.25s ease;
        }

        .diagram-button:hover {
            transform: translateY(-4px);
            box-shadow: 0 24px 46px rgba(79, 70, 229, 0.3);
        }

        .panels {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.45);
            backdrop-filter: blur(14px);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2.5rem 2rem;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.35s ease;
            z-index: 20;
            overflow: auto;
        }

        .panels.visible {
            opacity: 1;
            pointer-events: auto;
        }

        .panel {
            width: min(1500px, 100vw - 64px);
            max-height: calc(100vh - 96px);
            background: #f8fafc;
            border-radius: 28px;
            border: 1px solid rgba(148, 163, 184, 0.35);
            box-shadow: 0 35px 70px rgba(15, 23, 42, 0.25);
            display: none;
            flex-direction: column;
            overflow: hidden;
            transform: translateY(40px) scale(0.97);
            opacity: 0;
            transition: transform 0.35s ease, opacity 0.35s ease;
        }

        .panel.active {
            display: flex;
            transform: translateY(0) scale(1);
            opacity: 1;
        }

        .panel.focus-mode {
            width: min(1740px, 100vw - 40px);
            max-height: calc(100vh - 48px);
        }

        .panel-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1.5rem 2rem;
            border-bottom: 1px solid rgba(148, 163, 184, 0.35);
            background: rgba(226, 232, 240, 0.6);
        }

        .panel-header h2 {
            margin: 0;
            font-size: 1.8rem;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            color: #1f2937;
        }

        .panel-actions {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .toggle-bar {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 0.75rem;
        }

        .toggle {
            display: inline-flex;
            align-items: center;
            gap: 0.45rem;
            padding: 0.45rem 0.9rem;
            border-radius: 999px;
            border: 1px solid rgba(148, 163, 184, 0.5);
            background: rgba(248, 250, 252, 0.85);
            font-size: 0.82rem;
            color: #1f2937;
        }

        .toggle input {
            accent-color: #2563eb;
            width: 16px;
            height: 16px;
        }

        .panel-body {
            flex: 1;
            min-height: 0;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            padding: 1.5rem 1.75rem 1.75rem;
        }

        .focus-button,
        .back-button {
            border: 1px solid rgba(148, 163, 184, 0.6);
            border-radius: 999px;
            padding: 0.55rem 1.35rem;
            background: #fff;
            color: #1f2937;
            font-weight: 500;
            letter-spacing: 0.04em;
            cursor: pointer;
            transition: background 0.25s ease, color 0.25s ease, box-shadow 0.25s ease;
        }

        .focus-button:hover,
        .back-button:hover {
            background: #2563eb;
            color: #fff;
            box-shadow: 0 10px 24px rgba(37, 99, 235, 0.25);
        }

        .focus-button.active {
            background: #1e40af;
            color: #f8fafc;
        }

        .diagram-wrapper,
        .usecase-layout,
        .der-wrapper {
            position: relative;
            border: 1px solid rgba(148, 163, 184, 0.35);
            border-radius: 22px;
            background: linear-gradient(180deg, #ffffff 0%, #f5f7fa 100%);
            padding: 1.25rem;
            overflow: auto;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .diagram-wrapper svg,
        .usecase-layout svg,
        .der-wrapper svg {
            width: 100%;
            height: auto;
            flex: 1;
        }


        .hidden {
            display: none !important;
        }

        .legend {
            margin-top: auto;
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            font-size: 0.85rem;
            color: #475569;
        }

        .legend span::before {
            content: "";
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 3px;
            margin-right: 0.5rem;
        }

        .legend .public::before { background: #bfdbfe; }
        .legend .private::before { background: #bbf7d0; }
        .legend .security::before { background: #fde68a; }
        .legend .data::before { background: #c7d2fe; }

        svg text {
            font-family: 'Inter', sans-serif;
            font-size: 16px;
        }

        .entity-header {
            font-weight: 600;
            fill: #0f172a;
        }

        .entity-attr {
            fill: #1f2937;
            font-size: 15px;
        }

        .deployment-node rect,
        .deployment-node ellipse,
        .deployment-node path,
        .deployment-node polygon {
            transition: filter 0.3s ease, opacity 0.3s ease;
        }

        .deployment-link path,
        .deployment-link text {
            transition: opacity 0.3s ease;
        }

        .deployment-link path {
            stroke: #2563eb;
            stroke-width: 3;
            fill: none;
            stroke-linecap: round;
            marker-end: url(#deployment-arrow);
        }

        .deployment-link text {
            font-size: 14px;
            fill: #1e3a8a;
        }

        .link-label {
            fill: #0f172a;
            font-size: 14px;
            font-weight: 600;
        }

        .deployment-link.planned path {
            stroke: #9ca3af;
            stroke-dasharray: 10 8;
            marker-end: url(#deployment-arrow-muted);
        }

        .deployment-node .badge {
            font-size: 12px;
            fill: #1f2937;
        }

        .planned {
            opacity: 0.35;
        }

        .planned.active-planned {
            opacity: 0.65;
        }

        .deployment-node.active {
            filter: drop-shadow(0 0 16px rgba(37, 99, 235, 0.35));
        }

        .deployment-node.dimmed,
        .deployment-link.dimmed {
            opacity: 0.4;
        }


        .usecase-layout {
            position: relative;
        }

        .usecase-diagram {
            width: 100%;
            height: auto;
        }

        .actor {
            cursor: pointer;
            transform-box: fill-box;
            transform-origin: center;
            transition: transform 0.6s ease, opacity 0.45s ease, filter 0.45s ease;
        }

        .actor text {
            transition: opacity 0.4s ease, transform 0.45s ease;
        }

        .usecase-diagram[data-state="teaser"] .actor {
            transform: translate(var(--teaser-x, 0), var(--teaser-y, 0)) scale(1.04);
        }

        .usecase-diagram[data-state="teaser"] .actor text {
            opacity: 0.55;
            transform: translateY(-10px);
        }

        .usecase-diagram[data-active-actor] .actor {
            opacity: 0.35;
        }

        .usecase-diagram[data-active-actor] .actor.active-actor {
            opacity: 1;
            filter: drop-shadow(0 0 22px rgba(37, 99, 235, 0.45));
        }

        .system-elements {
            transition: opacity 0.55s ease, transform 0.6s ease;
        }

        .usecase-diagram[data-state="teaser"] .system-elements {
            opacity: 0;
            transform: translateX(70px) scale(0.95);
            pointer-events: none;
        }

        .usecase-diagram[data-state="active"] .system-elements {
            opacity: 1;
            transform: translateX(0) scale(1);
        }

        .usecase-group {
            transition: opacity 0.45s ease, transform 0.45s ease;
            cursor: pointer;
            pointer-events: visiblePainted;
        }

        .usecase-diagram[data-active-actor] .usecase-group {
            opacity: 0.28;
        }

        .usecase-group.highlight {
            opacity: 1 !important;
        }

        .usecase {
            fill: #f8fafc;
            stroke: #2563eb;
            stroke-width: 2.2;
            transition: stroke-width 0.3s ease, fill 0.3s ease;
        }

        .usecase-group.highlight .usecase {
            fill: #e0e7ff;
            stroke-width: 2.6;
        }

        .usecase-label {
            fill: #1f2937;
            font-size: 14px;
            transition: fill 0.3s ease, font-weight 0.3s ease;
        }

        .usecase-group.highlight .usecase-label {
            fill: #0f172a;
            font-weight: 600;
        }

        .system-rect {
            fill: rgba(191, 219, 254, 0.32);
            stroke: #2563eb;
            stroke-width: 2;
        }

        .actor-connector {
            stroke: #1d4ed8;
            stroke-width: 2.6;
            fill: none;
            stroke-linecap: round;
            opacity: 0;
            transition: opacity 0.4s ease;
        }

        .usecase-diagram[data-active-actor] .actor-connector {
            opacity: 0.22;
        }

        .actor-connector.active-connector {
            opacity: 1 !important;
        }

        .relation-line {
            stroke-width: 2;
            fill: none;
            marker-end: url(#relation-arrow);
            stroke-dashoffset: 24;
            opacity: 0;
            transition: opacity 0.4s ease, stroke-dashoffset 0.6s ease;
        }

        .usecase-diagram[data-active-actor] .relation-line {
            opacity: 0.18;
        }

        .relation-line.include { stroke: #059669; stroke-dasharray: 8 6; }
        .relation-line.exclude { stroke: #dc2626; stroke-dasharray: 4 6; marker-end: none; }

        .relation-line.active-relation {
            opacity: 1 !important;
            stroke-dashoffset: 0;
        }

        .note {
            fill: #475569;
            font-size: 13px;
            opacity: 0;
            transition: opacity 0.4s ease;
        }

        .usecase-diagram[data-active-actor] .note {
            opacity: 0.8;
        }

        .der-wrapper svg rect {
            fill: #f8fafc;
            stroke: #cbd5f5;
            stroke-width: 2;
            rx: 18;
        }

        .entity-badges {
            fill: #1f2937;
            font-size: 13px;
            font-weight: 600;
        }

        .entity-badges {
            font-size: 11px;
            fill: rgba(248, 250, 252, 0.85);
            letter-spacing: 0.14em;
            text-transform: uppercase;
        }

        .relationship-line {
            stroke: #1d4ed8;
            stroke-width: 2.6;
            fill: none;
            marker-end: url(#der-arrow);
            transition: opacity 0.3s ease;
        }

        .relationship-line.dimmed,
        .entity.dimmed {
            opacity: 0.4;
        }

        .cardinality {
            fill: #1f2937;
            font-size: 13px;
            font-weight: 600;
        }

        .cardinality,
        .relationship-label {
            fill: #334155;
            font-size: 13px;
        }

        .entity.dimmed { opacity: 0.4; }
        .entity.active { filter: drop-shadow(0 0 20px rgba(129, 140, 248, 0.75)); }

        .der-note {
            fill: #475569;
            font-size: 13px;
        }

        @media (max-width: 1024px) {
            body { padding: 1.5rem; }
            .hero { padding: 2.25rem 1.75rem; }
            .buttons { grid-template-columns: 1fr; }
            .panel {
                width: min(100%, 100vw - 32px);
                height: min(100%, 100vh - 32px);
            }
            .panel-body {
                grid-template-columns: 1fr;
            }
            .side-panel {
                order: -1;
                height: 240px;
                overflow-y: auto;
            }
        }
    </style>
</head>
<body>
    <section class="hero">
        <h1>Coyahue Helpdesk</h1>
        <div class="buttons">
            <button class="diagram-button" data-panel="deployment">Vista de Despliegue</button>
            <button class="diagram-button" data-panel="usecases">Casos de Uso</button>
            <button class="diagram-button" data-panel="der">Modelo de Datos</button>
        </div>
    </section>

    <div class="panels" id="panels">
        <!-- VISTA DE DESPLIEGUE -->
        <section class="panel" id="deployment" data-view="deployment">
            <div class="panel-header">
                <h2>Arquitectura de Despliegue</h2>
                <div class="panel-actions">
                    <div class="toggle-bar">
                        <label class="toggle"><input type="checkbox" data-toggle="igw"> Mostrar IGW</label>
                        <label class="toggle"><input type="checkbox" data-toggle="nat"> Mostrar NAT</label>
                        <label class="toggle"><input type="checkbox" data-toggle="s3"> Mostrar S3</label>
                        <label class="toggle"><input type="checkbox" data-toggle="waf"> Mostrar WAF/ALB</label>
                    </div>
                    <button class="focus-button" data-focus>Ampliar diagrama</button>
                    <button class="back-button" data-close>Volver</button>
                </div>
            </div>
            <div class="panel-body">
                <div class="diagram-wrapper">
                    <svg id="deployment-svg" viewBox="0 0 1700 920" role="img" aria-labelledby="deploymentTitle deploymentDesc" preserveAspectRatio="xMidYMid meet">
                        <title id="deploymentTitle">Despliegue Coyahue Helpdesk en AWS</title>
                        <desc id="deploymentDesc">Topología con cliente, internet, VPC en AWS, EC2 con Nginx, Gunicorn y Django, almacenamiento local y PostgreSQL en subred privada.</desc>
                        <defs>
                            <marker id="deployment-arrow" markerWidth="14" markerHeight="14" refX="10" refY="7" orient="auto" markerUnits="strokeWidth">
                                <polygon points="0 0, 14 7, 0 14" fill="#2563eb"></polygon>
                            </marker>
                            <marker id="deployment-arrow-muted" markerWidth="14" markerHeight="14" refX="10" refY="7" orient="auto" markerUnits="strokeWidth">
                                <polygon points="0 0, 14 7, 0 14" fill="#9ca3af"></polygon>
                            </marker>
                            <marker id="arrow-dashed" markerWidth="10" markerHeight="10" refX="8" refY="5" orient="auto" markerUnits="strokeWidth">
                                <polygon points="0 0, 10 5, 0 10" fill="rgba(148, 163, 184, 0.7)"></polygon>
                            </marker>
                        </defs>
                        <g data-node="Cliente" class="deployment-node">
                            <rect x="80" y="360" width="200" height="200" rx="22" fill="#bfdbfe" stroke="#60a5fa" stroke-width="2.4"></rect>
                            <text x="180" y="412" text-anchor="middle" class="entity-header">Cliente</text>
                            <text x="180" y="442" text-anchor="middle" class="entity-attr">Navegador web</text>
                            <text x="180" y="470" text-anchor="middle" class="entity-attr">TLS + Autenticación</text>
                        </g>

                        <g data-node="Internet" class="deployment-node">
                            <path d="M340 320 C330 280 390 250 430 265 C450 225 530 225 550 265 C600 255 640 290 630 330 C670 350 660 400 610 410 C590 450 510 460 480 430 C430 450 370 430 380 380 C340 372 338 340 340 320 Z" fill="#e0e7ff" stroke="#6366f1" stroke-width="2.4"></path>
                            <text x="495" y="318" text-anchor="middle" class="entity-header">Internet</text>
                            <text x="495" y="348" text-anchor="middle" class="entity-attr">Acceso público</text>
                        </g>

                        <g data-node="IGW" class="deployment-node planned hidden" data-toggle-group="igw">
                            <polygon points="820,240 880,240 910,280 880,320 820,320 790,280" fill="#e5e7eb" stroke="#94a3b8" stroke-width="2"></polygon>
                            <text x="825" y="272" text-anchor="middle" class="entity-attr">Internet Gateway</text>
                            <text x="825" y="296" text-anchor="middle" class="badge">Por implementar</text>
                            <title>Se agregará a la tabla de rutas de la subred pública.</title>
                        </g>

                        <g data-node="AWS VPC" class="deployment-node">
                            <rect x="620" y="150" width="900" height="540" rx="28" fill="rgba(191, 219, 254, 0.25)" stroke="#38bdf8" stroke-width="2.6"></rect>
                            <text x="1480" y="190" text-anchor="end" class="entity-header">AWS VPC</text>
                        </g>

                        <g data-node="Subred pública" class="deployment-node">
                            <rect x="660" y="210" width="440" height="460" rx="24" fill="rgba(187, 247, 208, 0.6)" stroke="#4ade80" stroke-width="2"></rect>
                            <text x="880" y="260" text-anchor="middle" class="entity-header">Subred pública</text>
                        </g>

                        <g data-node="Subred privada" class="deployment-node">
                            <rect x="1140" y="210" width="320" height="460" rx="24" fill="rgba(191, 219, 254, 0.55)" stroke="#60a5fa" stroke-width="2"></rect>
                            <text x="1300" y="260" text-anchor="middle" class="entity-header">Subred privada</text>
                        </g>

                        <g data-node="Entrada VPC" class="deployment-node">
                            <rect x="700" y="320" width="200" height="200" rx="20" fill="#bbf7d0" stroke="#22c55e" stroke-width="2.4"></rect>
                            <text x="800" y="370" text-anchor="middle" class="entity-header">Entrada VPC</text>
                            <text x="800" y="402" text-anchor="middle" class="entity-attr">Security Group</text>
                            <text x="800" y="434" text-anchor="middle" class="entity-attr">HTTPS 443 · Egress controlado</text>
                        </g>

                        <g data-node="WAF/ALB" class="deployment-node planned hidden" data-toggle-group="waf">
                            <rect x="920" y="340" width="120" height="180" rx="20" fill="#f8fafc" stroke="#d1d5db" stroke-width="2.4"></rect>
                            <text x="980" y="408" text-anchor="middle" class="entity-attr">WAF / ALB</text>
                            <text x="980" y="438" text-anchor="middle" class="badge">Por implementar</text>
                            <title>Seguridad perimetral y balanceo de carga.</title>
                        </g>

                        <g data-node="NAT Gateway" class="deployment-node planned hidden" data-toggle-group="nat">
                            <rect x="1180" y="230" width="160" height="60" rx="14" fill="#f1f5f9" stroke="#94a3b8" stroke-width="2"></rect>
                            <text x="1260" y="262" text-anchor="middle" class="entity-attr">NAT Gateway</text>
                            <text x="1260" y="288" text-anchor="middle" class="badge">Por implementar</text>
                            <title>Para actualizaciones desde la subred privada sin exponer la base de datos.</title>
                        </g>

                        <g data-node="EC2 App" class="deployment-node">
                            <rect x="980" y="320" width="280" height="300" rx="22" fill="#dbeafe" stroke="#60a5fa" stroke-width="2.4"></rect>
                            <line x1="980" y1="380" x2="1260" y2="380" stroke="#94a3b8" stroke-width="1.5"></line>
                            <line x1="980" y1="440" x2="1260" y2="440" stroke="#94a3b8" stroke-width="1.5"></line>
                            <text x="1120" y="350" text-anchor="middle" class="entity-header">EC2 App</text>
                            <text x="1120" y="372" text-anchor="middle" class="entity-attr">Nginx · HTTPS (443)</text>
                            <text x="1120" y="432" text-anchor="middle" class="entity-attr">Gunicorn</text>
                            <text x="1120" y="492" text-anchor="middle" class="entity-attr">Django + DRF</text>
                        </g>

                        <g data-node="/media" class="deployment-node">
                            <rect x="1020" y="640" width="120" height="90" rx="16" fill="#ede9fe" stroke="#a855f7" stroke-width="1.8"></rect>
                            <text x="1080" y="680" text-anchor="middle" class="entity-attr">/media</text>
                            <text x="1080" y="706" text-anchor="middle" class="entity-attr">Adjuntos</text>
                        </g>

                        <g data-node="Logs" class="deployment-node">
                            <rect x="1150" y="640" width="120" height="90" rx="16" fill="#ede9fe" stroke="#a855f7" stroke-width="1.8"></rect>
                            <text x="1210" y="680" text-anchor="middle" class="entity-attr">Logs</text>
                            <text x="1210" y="706" text-anchor="middle" class="entity-attr">Aplicación</text>
                        </g>

                        <g data-node="S3" class="deployment-node planned hidden" data-toggle-group="s3">
                            <rect x="1280" y="620" width="200" height="120" rx="20" fill="#f9fafb" stroke="#cbd5f5" stroke-width="2"></rect>
                            <text x="1380" y="668" text-anchor="middle" class="entity-attr">S3 (adjuntos)</text>
                            <text x="1380" y="698" text-anchor="middle" class="badge">Por implementar</text>
                            <title>Migración prevista de /media a S3 mediante django-storages.</title>
                        </g>

                        <g data-node="PostgreSQL" class="deployment-node">
                            <ellipse cx="1300" cy="420" rx="120" ry="65" fill="#bae6fd" stroke="#0ea5e9" stroke-width="2.4"></ellipse>
                            <text x="1300" y="410" text-anchor="middle" class="entity-header">PostgreSQL</text>
                            <text x="1300" y="438" text-anchor="middle" class="entity-attr">Puerto 5432</text>
                        </g>

                        <g data-edge="Cliente-Internet" class="deployment-link" data-source="Cliente" data-target="Internet">
                            <path d="M280 460 H340"></path>
                        </g>

                        <g data-edge="Internet-Entrada" class="deployment-link" data-source="Internet" data-target="Entrada VPC">
                            <path d="M560 420 H700"></path>
                        </g>

                        <g data-edge="Entrada-WAF" class="deployment-link planned hidden" data-toggle-group="waf" data-source="Entrada VPC" data-target="WAF/ALB">
                            <path d="M900 420 H920"></path>
                        </g>

                        <g data-edge="WAF-EC2" class="deployment-link planned hidden" data-toggle-group="waf" data-source="WAF/ALB" data-target="EC2 App">
                            <path d="M1040 420 H1120"></path>
                        </g>

                        <g data-edge="Entrada-EC2" class="deployment-link" data-source="Entrada VPC" data-target="EC2 App">
                            <path d="M900 420 H980"></path>
                        </g>

                        <g data-edge="EC2-Postgres" class="deployment-link" data-source="EC2 App" data-target="PostgreSQL">
                            <path d="M1260 460 H1300"></path>
                            <text x="1280" y="380" class="link-label">Tráfico interno VPC</text>
                        </g>

                        <g data-edge="EC2-media" class="deployment-link" data-source="EC2 App" data-target="/media">
                            <path d="M1120 620 V640"></path>
                        </g>

                        <g data-edge="EC2-logs" class="deployment-link" data-source="EC2 App" data-target="Logs">
                            <path d="M1250 620 V640"></path>
                        </g>

                        <g data-edge="Postgres-EC2" class="deployment-link" data-source="PostgreSQL" data-target="EC2 App">
                            <path d="M1380 380 H1260"></path>
                        </g>

                        <g data-edge="NAT-Privada" class="deployment-link planned hidden" data-toggle-group="nat" data-source="NAT Gateway" data-target="Subred privada">
                            <path d="M1260 230 V210 H1140"></path>
                            <text x="1180" y="198" class="link-label">Salida controlada</text>
                        </g>

                        <g data-edge="Privada-NAT" class="deployment-link planned hidden" data-toggle-group="nat" data-source="Subred privada" data-target="NAT Gateway">
                            <path d="M1140 210 H1260 V230"></path>
                        </g>

                        <g data-edge="Django-S3" class="deployment-link planned hidden" data-toggle-group="s3" data-source="EC2 App" data-target="S3">
                            <path d="M1260 580 V620 H1280"></path>
                        </g>

                        <g data-edge="Internet-IGW" class="deployment-link planned hidden" data-toggle-group="igw" data-source="Internet" data-target="IGW">
                            <path d="M560 300 H820"></path>
                        </g>

                        <g data-edge="IGW-Entrada" class="deployment-link planned hidden" data-toggle-group="igw" data-source="IGW" data-target="Entrada VPC">
                            <path d="M880 280 H860 V320"></path>
                        </g>

                        <g data-edge="Internet-WAF" class="deployment-link planned hidden" data-toggle-group="waf" data-source="Internet" data-target="WAF/ALB">
                            <path d="M560 420 H920"></path>
                        </g>
                    </svg>
                    <div class="legend">
                        <span class="public">Subred pública · EC2 · Nginx/Gunicorn</span>
                        <span class="private">Subred privada · PostgreSQL</span>
                        <span class="security">TLS · Seguridad</span>
                        <span class="data">/media · Logs</span>
                    </div>
                </div>
            </div>
        </section>
        <!-- VISTA CASOS DE USO -->
        <section class="panel" id="usecases" data-view="usecases">
            <div class="panel-header">
                <h2>Casos de Uso</h2>
                <div class="panel-actions">
                    <button class="focus-button" data-focus>Ampliar diagrama</button>
                    <button class="back-button" data-close>Volver</button>
                </div>
            </div>
            <div class="panel-body">
                <div class="usecase-layout">
                    <svg id="usecase-svg" class="usecase-diagram" data-state="teaser" viewBox="0 0 1200 760" role="img" aria-labelledby="usecaseTitle usecaseDesc">
                        <title id="usecaseTitle">Casos de uso del sistema de tickets</title>
                        <desc id="usecaseDesc">Actores solicitante, técnico y administrador interactuando con el sistema de tickets y sus funcionalidades clave.</desc>
                        <defs>
                            <marker id="relation-arrow" markerWidth="8" markerHeight="8" refX="6" refY="4" orient="auto" markerUnits="strokeWidth">
                                <polygon points="0 0, 8 4, 0 8" fill="#059669"></polygon>
                            </marker>
                        </defs>

                        <g class="actors-layer">
                            <g class="actor" data-node="Solicitante" data-kind="actor" style="--teaser-x: 0; --teaser-y: 0;">
                                <circle cx="360" cy="600" r="18" stroke="#2563eb" stroke-width="3" fill="none"></circle>
                                <line x1="360" y1="618" x2="360" y2="672" stroke="#2563eb" stroke-width="3"></line>
                                <line x1="330" y1="632" x2="390" y2="632" stroke="#2563eb" stroke-width="3"></line>
                                <line x1="360" y1="672" x2="338" y2="712" stroke="#2563eb" stroke-width="3"></line>
                                <line x1="360" y1="672" x2="382" y2="712" stroke="#2563eb" stroke-width="3"></line>
                                <text x="360" y="742" text-anchor="middle" class="entity-header">Solicitante</text>
                            </g>
                            <g class="actor" data-node="Técnico" data-kind="actor" style="--teaser-x: 0; --teaser-y: 0;">
                                <circle cx="520" cy="600" r="18" stroke="#2563eb" stroke-width="3" fill="none"></circle>
                                <line x1="520" y1="618" x2="520" y2="672" stroke="#2563eb" stroke-width="3"></line>
                                <line x1="490" y1="632" x2="550" y2="632" stroke="#2563eb" stroke-width="3"></line>
                                <line x1="520" y1="672" x2="498" y2="712" stroke="#2563eb" stroke-width="3"></line>
                                <line x1="520" y1="672" x2="542" y2="712" stroke="#2563eb" stroke-width="3"></line>
                                <text x="520" y="742" text-anchor="middle" class="entity-header">Técnico</text>
                            </g>
                            <g class="actor" data-node="Administrador" data-kind="actor" style="--teaser-x: 0; --teaser-y: 0;">
                                <circle cx="820" cy="600" r="18" stroke="#2563eb" stroke-width="3" fill="none"></circle>
                                <line x1="820" y1="618" x2="820" y2="672" stroke="#2563eb" stroke-width="3"></line>
                                <line x1="790" y1="632" x2="850" y2="632" stroke="#2563eb" stroke-width="3"></line>
                                <line x1="820" y1="672" x2="798" y2="712" stroke="#2563eb" stroke-width="3"></line>
                                <line x1="820" y1="672" x2="842" y2="712" stroke="#2563eb" stroke-width="3"></line>
                                <text x="820" y="742" text-anchor="middle" class="entity-header">Administrador</text>
                            </g>
                        </g>

                        <g class="system-elements">
                            <g data-node="Sistema" data-kind="system">
                                <rect class="system-rect" x="220" y="140" width="760" height="420" rx="28"></rect>
                                <text x="600" y="180" text-anchor="middle" class="entity-header">Casos</text>
                            </g>

                            <g class="usecases-layer">
                                <g data-node="FAQ autoservicio" class="usecase-group">
                                    <ellipse class="usecase" cx="360" cy="220" rx="120" ry="34"></ellipse>
                                    <text class="usecase-label" data-usecase="FAQ autoservicio" x="360" y="226" text-anchor="middle">FAQ autoservicio</text>
                                </g>
                                <g data-node="Crear ticket" class="usecase-group">
                                    <ellipse class="usecase" cx="360" cy="300" rx="120" ry="34"></ellipse>
                                    <text class="usecase-label" data-usecase="Crear ticket" x="360" y="306" text-anchor="middle">Crear ticket</text>
                                </g>
                                <g data-node="Adjuntar y comentar" class="usecase-group">
                                    <ellipse class="usecase" cx="520" cy="300" rx="128" ry="34"></ellipse>
                                    <text class="usecase-label" data-usecase="Adjuntar y comentar" x="520" y="306" text-anchor="middle">Adjuntar y comentar</text>
                                </g>
                                <g data-node="Ver y filtrar tickets" class="usecase-group">
                                    <ellipse class="usecase" cx="700" cy="300" rx="132" ry="34"></ellipse>
                                    <text class="usecase-label" data-usecase="Ver y filtrar tickets" x="700" y="306" text-anchor="middle">Ver y filtrar tickets</text>
                                </g>
                                <g data-node="Cambiar estado" class="usecase-group">
                                    <ellipse class="usecase" cx="520" cy="380" rx="120" ry="34"></ellipse>
                                    <text class="usecase-label" data-usecase="Cambiar estado" x="520" y="386" text-anchor="middle">Cambiar estado</text>
                                </g>
                                <g data-node="Asignar/Reasignar" class="usecase-group">
                                    <ellipse class="usecase" cx="700" cy="380" rx="128" ry="34"></ellipse>
                                    <text class="usecase-label" data-usecase="Asignar/Reasignar" x="700" y="386" text-anchor="middle">Asignar/Reasignar</text>
                                </g>
                                <g data-node="Dashboard KPI" class="usecase-group">
                                    <ellipse class="usecase" cx="860" cy="380" rx="128" ry="34"></ellipse>
                                    <text class="usecase-label" data-usecase="Dashboard KPI" x="860" y="386" text-anchor="middle">Dashboard KPI</text>
                                </g>
                                <g data-node="Exportar PDF/Excel" class="usecase-group">
                                    <ellipse class="usecase" cx="700" cy="460" rx="132" ry="34"></ellipse>
                                    <text class="usecase-label" data-usecase="Exportar PDF/Excel" x="700" y="466" text-anchor="middle">Exportar PDF/Excel</text>
                                </g>
                                <g data-node="Gestionar catálogos" class="usecase-group">
                                    <ellipse class="usecase" cx="860" cy="460" rx="138" ry="34"></ellipse>
                                    <text class="usecase-label" data-usecase="Gestionar catálogos" x="860" y="466" text-anchor="middle">Gestionar catálogos</text>
                                </g>
                                <g data-node="Auditoría" class="usecase-group">
                                    <ellipse class="usecase" cx="860" cy="520" rx="128" ry="34"></ellipse>
                                    <text class="usecase-label" data-usecase="Auditoría" x="860" y="526" text-anchor="middle">Auditoría</text>
                                </g>
                            </g>

                            <g class="connectors-layer">
                                <path class="actor-connector" data-source="Solicitante" data-target="FAQ autoservicio" d="M360 560 V220"></path>
                                <path class="actor-connector" data-source="Solicitante" data-target="Crear ticket" d="M360 560 V300"></path>
                                <path class="actor-connector" data-source="Solicitante" data-target="Adjuntar y comentar" d="M360 560 V320 H520"></path>
                                <path class="actor-connector" data-source="Solicitante" data-target="Ver y filtrar tickets" d="M360 560 V340 H700"></path>

                                <path class="actor-connector" data-source="Técnico" data-target="Adjuntar y comentar" d="M520 560 V320"></path>
                                <path class="actor-connector" data-source="Técnico" data-target="Cambiar estado" d="M520 560 V380"></path>
                                <path class="actor-connector" data-source="Técnico" data-target="Asignar/Reasignar" d="M520 560 V380 H700"></path>
                                <path class="actor-connector" data-source="Técnico" data-target="Ver y filtrar tickets" d="M520 560 V340 H700"></path>
                                <path class="actor-connector" data-source="Técnico" data-target="Dashboard KPI" d="M520 560 V400 H860"></path>

                                <path class="actor-connector" data-source="Administrador" data-target="Ver y filtrar tickets" d="M820 560 V340 H700"></path>
                                <path class="actor-connector" data-source="Administrador" data-target="Asignar/Reasignar" d="M820 560 V380 H700"></path>
                                <path class="actor-connector" data-source="Administrador" data-target="Dashboard KPI" d="M820 560 V400 H860"></path>
                                <path class="actor-connector" data-source="Administrador" data-target="Exportar PDF/Excel" d="M820 560 V460 H700"></path>
                                <path class="actor-connector" data-source="Administrador" data-target="Gestionar catálogos" d="M820 560 V460 H860"></path>
                                <path class="actor-connector" data-source="Administrador" data-target="Auditoría" d="M820 560 V520 H860"></path>
                            </g>

                            <text x="280" y="600" class="note">FAQ excluye la creación de ticket cuando resuelve la solicitud.</text>
                        </g>
                    </svg>
                </div>
            </div>
        </section>
        <!-- VISTA DER -->
        <section class="panel" id="der" data-view="der">
            <div class="panel-header">
                <h2>Diagrama Entidad-Relación</h2>
                <div class="panel-actions">
                    <button class="focus-button" data-focus>Ampliar diagrama</button>
                    <button class="back-button" data-close>Volver</button>
                </div>
            </div>
            <div class="panel-body">
                <div class="der-wrapper">
                    <svg id="der-svg" viewBox="0 0 1760 1120" role="img" aria-labelledby="derTitle derDesc" preserveAspectRatio="xMidYMid meet">
                        <title id="derTitle">Modelo de datos Coyahue Helpdesk</title>
                        <desc id="derDesc">Entidades auth_user, Category, Subcategory, Ticket, Priority, Area y los registros relacionados de comentarios, adjuntos, asignaciones y auditoría.</desc>
                        <defs>
                            <marker id="der-arrow" markerWidth="10" markerHeight="10" refX="8" refY="5" orient="auto" markerUnits="strokeWidth">
                                <polygon points="0 0, 10 5, 0 10" fill="#2563eb"></polygon>
                            </marker>
                        </defs>

                        <g data-node="auth_user" class="entity" transform="translate(80,140)">
                            <rect width="320" height="220"></rect>
                            <text x="160" y="32" text-anchor="middle" class="entity-header">auth_user</text>
                            <text x="20" y="70" class="entity-badges">PK</text>
                            <text x="20" y="100" class="entity-attr">• id (PK)</text>
                            <text x="20" y="120" class="entity-attr">• username</text>
                            <text x="20" y="140" class="entity-attr">• password (hash)</text>
                            <text x="20" y="160" class="entity-attr">• email</text>
                            <text x="20" y="180" class="entity-attr">• is_active · is_staff</text>
                        </g>

                        <g data-node="Category" class="entity" transform="translate(420,140)">
                            <rect width="300" height="220"></rect>
                            <text x="150" y="32" text-anchor="middle" class="entity-header">Category</text>
                            <text x="20" y="70" class="entity-badges">UNIQUE</text>
                            <text x="20" y="100" class="entity-attr">• id (PK)</text>
                            <text x="20" y="120" class="entity-attr">• name</text>
                            <text x="20" y="140" class="entity-attr">• description</text>
                            <text x="20" y="160" class="entity-attr">• is_active</text>
                            <text x="20" y="180" class="entity-attr">Nota: nombres normalizados en MAYÚSCULAS</text>
                        </g>

                        <g data-node="Subcategory" class="entity" transform="translate(760,140)">
                            <rect width="320" height="240"></rect>
                            <text x="160" y="32" text-anchor="middle" class="entity-header">Subcategory</text>
                            <text x="20" y="70" class="entity-badges">FK</text>
                            <text x="20" y="100" class="entity-attr">• id (PK)</text>
                            <text x="20" y="120" class="entity-attr">• category_id (FK)</text>
                            <text x="20" y="140" class="entity-attr">• name</text>
                            <text x="20" y="160" class="entity-attr">• description</text>
                            <text x="20" y="180" class="entity-attr">• is_active</text>
                            <text x="20" y="200" class="entity-attr">Nota: unicidad por categoría</text>
                        </g>

                        <g data-node="Ticket" class="entity" transform="translate(640,420)">
                            <rect width="340" height="380"></rect>
                            <text x="170" y="32" text-anchor="middle" class="entity-header">Ticket</text>
                            <text x="20" y="70" class="entity-badges">UNIQUE · INDEX</text>
                            <text x="20" y="100" class="entity-attr">• id (PK)</text>
                            <text x="20" y="120" class="entity-attr">• code (UNIQUE)</text>
                            <text x="20" y="140" class="entity-attr">• title · description</text>
                            <text x="20" y="160" class="entity-attr">• kind {REQUEST|INCIDENT}</text>
                            <text x="20" y="180" class="entity-attr">• status {OPEN|IN_PROGRESS|RESOLVED|CLOSED}</text>
                            <text x="20" y="200" class="entity-attr">• requester_id (FK)</text>
                            <text x="20" y="220" class="entity-attr">• assigned_to_id (FK, NULL)</text>
                            <text x="20" y="240" class="entity-attr">• category_id (FK)</text>
                            <text x="20" y="260" class="entity-attr">• subcategory_id (FK, NULL)</text>
                            <text x="20" y="280" class="entity-attr">• priority_id (FK)</text>
                            <text x="20" y="300" class="entity-attr">• area_id (FK, NULL)</text>
                            <text x="20" y="320" class="entity-attr">• created_at (INDEX) · updated_at</text>
                            <text x="20" y="340" class="entity-attr">• resolved_at? · closed_at? · cluster_id (INDEX·DEPRECATED)</text>
                        </g>

                        <g data-node="Priority" class="entity" transform="translate(1120,140)">
                            <rect width="280" height="220"></rect>
                            <text x="140" y="32" text-anchor="middle" class="entity-header">Priority</text>
                            <text x="20" y="70" class="entity-badges">UNIQUE</text>
                            <text x="20" y="100" class="entity-attr">• id (PK)</text>
                            <text x="20" y="120" class="entity-attr">• name</text>
                            <text x="20" y="140" class="entity-attr">• sla_hours</text>
                        </g>

                        <g data-node="Area" class="entity" transform="translate(1440,140)">
                            <rect width="280" height="240"></rect>
                            <text x="140" y="32" text-anchor="middle" class="entity-header">Area</text>
                            <text x="20" y="70" class="entity-badges">UNIQUE</text>
                            <text x="20" y="100" class="entity-attr">• id (PK)</text>
                            <text x="20" y="120" class="entity-attr">• name</text>
                            <text x="20" y="140" class="entity-attr">• is_active</text>
                        </g>

                        <g data-node="TicketComment" class="entity" transform="translate(300,720)">
                            <rect width="300" height="240"></rect>
                            <text x="150" y="32" text-anchor="middle" class="entity-header">TicketComment</text>
                            <text x="20" y="70" class="entity-badges">FK</text>
                            <text x="20" y="100" class="entity-attr">• id (PK)</text>
                            <text x="20" y="120" class="entity-attr">• ticket_id (FK)</text>
                            <text x="20" y="140" class="entity-attr">• author_id (FK)</text>
                            <text x="20" y="160" class="entity-attr">• body</text>
                            <text x="20" y="180" class="entity-attr">• is_internal</text>
                            <text x="20" y="200" class="entity-attr">• created_at</text>
                        </g>

                        <g data-node="TicketAttachment" class="entity" transform="translate(620,720)">
                            <rect width="300" height="240"></rect>
                            <text x="150" y="32" text-anchor="middle" class="entity-header">TicketAttachment</text>
                            <text x="20" y="70" class="entity-badges">FK</text>
                            <text x="20" y="100" class="entity-attr">• id (PK)</text>
                            <text x="20" y="120" class="entity-attr">• ticket_id (FK)</text>
                            <text x="20" y="140" class="entity-attr">• uploaded_by_id (FK)</text>
                            <text x="20" y="160" class="entity-attr">• file</text>
                            <text x="20" y="180" class="entity-attr">• content_type · size</text>
                            <text x="20" y="200" class="entity-attr">• uploaded_at</text>
                        </g>

                        <g data-node="TicketAssignment" class="entity" transform="translate(940,720)">
                            <rect width="320" height="240"></rect>
                            <text x="160" y="32" text-anchor="middle" class="entity-header">TicketAssignment</text>
                            <text x="20" y="70" class="entity-badges">FK</text>
                            <text x="20" y="100" class="entity-attr">• id (PK)</text>
                            <text x="20" y="120" class="entity-attr">• ticket_id (FK)</text>
                            <text x="20" y="140" class="entity-attr">• from_user_id (FK, NULL)</text>
                            <text x="20" y="160" class="entity-attr">• to_user_id (FK)</text>
                            <text x="20" y="180" class="entity-attr">• reason</text>
                            <text x="20" y="200" class="entity-attr">• created_at</text>
                        </g>

                        <g data-node="AuditLog" class="entity" transform="translate(1260,720)">
                            <rect width="320" height="260"></rect>
                            <text x="160" y="32" text-anchor="middle" class="entity-header">AuditLog</text>
                            <text x="20" y="70" class="entity-badges">FK</text>
                            <text x="20" y="100" class="entity-attr">• id (PK)</text>
                            <text x="20" y="120" class="entity-attr">• ticket_id (FK)</text>
                            <text x="20" y="140" class="entity-attr">• actor_id (FK, NULL)</text>
                            <text x="20" y="160" class="entity-attr">• action {CREATE|ASSIGN|UPDATE|STATUS|COMMENT|ATTACH|SLA_WARN|SLA_BREACH}</text>
                            <text x="20" y="180" class="entity-attr">• meta (JSON)</text>
                            <text x="20" y="200" class="entity-attr">• created_at</text>
                        </g>
                        <path class="relationship-line" data-edge="user-ticket" data-source="auth_user" data-target="Ticket" d="M400 250 H640 V420 H810"></path>
                        <text x="460" y="238" class="cardinality">1..N</text>
                        <text x="460" y="262" class="relationship-label">requester (CASCADE)</text>

                        <path class="relationship-line" data-edge="user-assigned" data-source="auth_user" data-target="Ticket" d="M400 280 H600 V610 H640"></path>
                        <text x="460" y="360" class="cardinality">1..N</text>
                        <text x="460" y="384" class="relationship-label">assigned_to (SET_NULL)</text>

                        <path class="relationship-line" data-edge="category-subcategory" data-source="Category" data-target="Subcategory" d="M720 220 H760"></path>
                        <text x="740" y="208" class="cardinality">1..N</text>
                        <text x="740" y="234" class="relationship-label">category (CASCADE)</text>

                        <path class="relationship-line" data-edge="category-ticket" data-source="Category" data-target="Ticket" d="M570 360 V420 H640"></path>
                        <text x="582" y="388" class="cardinality">1..N</text>
                        <text x="586" y="412" class="relationship-label">category (PROTECT)</text>

                        <path class="relationship-line" data-edge="subcategory-ticket" data-source="Subcategory" data-target="Ticket" d="M920 380 V420 H810"></path>
                        <text x="932" y="398" class="cardinality">1..N</text>
                        <text x="940" y="420" class="relationship-label">subcategory (PROTECT, opcional)</text>

                        <path class="relationship-line" data-edge="priority-ticket" data-source="Priority" data-target="Ticket" d="M1120 250 V610 H980"></path>
                        <text x="1128" y="430" class="cardinality">1..N</text>
                        <text x="1132" y="454" class="relationship-label">priority (PROTECT)</text>

                        <path class="relationship-line" data-edge="area-ticket" data-source="Area" data-target="Ticket" d="M1440 260 V610 H980"></path>
                        <text x="1450" y="430" class="cardinality">1..N</text>
                        <text x="1454" y="454" class="relationship-label">area (PROTECT, opcional)</text>

                        <path class="relationship-line" data-edge="ticket-comment" data-source="Ticket" data-target="TicketComment" d="M810 800 V880 H450 V720"></path>
                        <text x="760" y="860" class="cardinality">1..N</text>
                        <text x="680" y="884" class="relationship-label">comentarios (CASCADE)</text>

                        <path class="relationship-line" data-edge="ticket-attachment" data-source="Ticket" data-target="TicketAttachment" d="M810 800 V760 H770 V720"></path>
                        <text x="792" y="748" class="cardinality">1..N</text>
                        <text x="802" y="772" class="relationship-label">adjuntos (CASCADE)</text>

                        <path class="relationship-line" data-edge="ticket-assignment" data-source="Ticket" data-target="TicketAssignment" d="M810 800 V780 H1100 V720"></path>
                        <text x="920" y="788" class="cardinality">1..N</text>
                        <text x="930" y="812" class="relationship-label">asignaciones (CASCADE)</text>

                        <path class="relationship-line" data-edge="ticket-audit" data-source="Ticket" data-target="AuditLog" d="M810 800 V900 H1420 V720"></path>
                        <text x="1040" y="892" class="cardinality">1..N</text>
                        <text x="1050" y="916" class="relationship-label">auditoría (CASCADE)</text>

                        <path class="relationship-line" data-edge="user-comment" data-source="auth_user" data-target="TicketComment" d="M240 360 V720 H450"></path>
                        <text x="220" y="520" class="cardinality">1..N</text>
                        <text x="226" y="544" class="relationship-label">author (CASCADE)</text>

                        <path class="relationship-line" data-edge="user-attachment" data-source="auth_user" data-target="TicketAttachment" d="M260 360 V720 H770"></path>
                        <text x="300" y="640" class="cardinality">1..N</text>
                        <text x="306" y="664" class="relationship-label">uploaded_by (CASCADE)</text>

                        <path class="relationship-line" data-edge="user-assignment-from" data-source="auth_user" data-target="TicketAssignment" d="M280 360 V720 H1100"></path>
                        <text x="420" y="640" class="cardinality">1..N</text>
                        <text x="426" y="664" class="relationship-label">from_user (SET_NULL)</text>

                        <path class="relationship-line" data-edge="user-assignment-to" data-source="auth_user" data-target="TicketAssignment" d="M300 360 V760 H1260 V720"></path>
                        <text x="520" y="660" class="cardinality">1..N</text>
                        <text x="526" y="684" class="relationship-label">to_user (CASCADE)</text>

                        <path class="relationship-line" data-edge="user-audit" data-source="auth_user" data-target="AuditLog" d="M320 360 V720 H1420"></path>
                        <text x="620" y="640" class="cardinality">1..N</text>
                        <text x="626" y="664" class="relationship-label">actor (SET_NULL)</text>

                        <text x="980" y="1060" class="der-note">Ticket.code es único; created_at está indexado para reportes y ticket.cluster_id permanece por compatibilidad (deprecated).</text>
                    </svg>
                </div>
            </div>
        </section>
    </div>
    <script>
        const panels = document.getElementById('panels');
        const diagramButtons = document.querySelectorAll('.diagram-button');
        const closeButtons = document.querySelectorAll('[data-close]');
        const focusButtons = document.querySelectorAll('[data-focus]');

        let currentPanel = null;

        diagramButtons.forEach(button => {
            button.addEventListener('click', () => {
                const targetId = button.getAttribute('data-panel');
                const panel = document.getElementById(targetId);
                if (!panel) return;

                if (currentPanel && currentPanel !== panel) {
                    currentPanel.classList.remove('active', 'focus-mode');
                    currentPanel.querySelectorAll('[data-focus]').forEach(btn => btn.classList.remove('active'));
                }

                currentPanel = panel;
                panels.classList.add('visible');
                panel.classList.add('active');
            });
        });

        closeButtons.forEach(button => {
            button.addEventListener('click', () => {
                if (currentPanel) {
                    currentPanel.classList.remove('active', 'focus-mode');
                    currentPanel.querySelectorAll('[data-focus]').forEach(btn => btn.classList.remove('active'));
                    panels.classList.remove('visible');
                    currentPanel = null;
                }
            });
        });

        focusButtons.forEach(button => {
            button.addEventListener('click', () => {
                const panel = button.closest('.panel');
                panel.classList.toggle('focus-mode');
                button.classList.toggle('active');
                button.textContent = panel.classList.contains('focus-mode') ? 'Salir de foco' : 'Ampliar diagrama';
            });
        });

        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape' && currentPanel) {
                currentPanel.classList.remove('active', 'focus-mode');
                currentPanel.querySelectorAll('[data-focus]').forEach(btn => btn.classList.remove('active'));
                panels.classList.remove('visible');
                currentPanel = null;
            }
        });

        const toggleInputs = document.querySelectorAll('[data-toggle]');
        toggleInputs.forEach(input => {
            input.addEventListener('change', () => {
                const target = input.getAttribute('data-toggle');
                document.querySelectorAll(`[data-toggle-group="${target}"]`).forEach(group => {
                    group.classList.toggle('hidden', !input.checked);
                    if (input.checked) {
                        group.classList.add('active-planned');
                    } else {
                        group.classList.remove('active-planned');
                    }
                });
            });
        });

        function buildAdjacency(panel, adjacency) {
            const nodes = panel.querySelectorAll('[data-node]');
            const edges = panel.querySelectorAll('[data-source][data-target]');
            let selected = null;

            function clearHighlight() {
                nodes.forEach(n => n.classList.remove('active', 'dimmed'));
                edges.forEach(e => e.classList.remove('active', 'dimmed'));
            }

            function applyHighlight(name) {
                clearHighlight();
                if (!name) return;
                const neighbors = adjacency[name] || [];
                nodes.forEach(n => n.classList.add('dimmed'));
                edges.forEach(e => e.classList.add('dimmed'));
                panel.querySelectorAll(`[data-node="${name}"]`).forEach(n => {
                    n.classList.remove('dimmed');
                    n.classList.add('active');
                });
                neighbors.forEach(neighbor => {
                    panel.querySelectorAll(`[data-node="${neighbor}"]`).forEach(n => {
                        n.classList.remove('dimmed');
                        n.classList.add('active');
                    });
                    panel.querySelectorAll(`[data-source="${name}"][data-target="${neighbor}"]`).forEach(edge => {
                        edge.classList.remove('dimmed');
                        edge.classList.add('active');
                    });
                    panel.querySelectorAll(`[data-source="${neighbor}"][data-target="${name}"]`).forEach(edge => {
                        edge.classList.remove('dimmed');
                        edge.classList.add('active');
                    });
                });
            }

            panel.addEventListener('click', (event) => {
                if (!event.target.closest('[data-node]') && selected) {
                    selected = null;
                    clearHighlight();
                    panel.dispatchEvent(new CustomEvent('nodeCleared'));
                }
            });

            nodes.forEach(node => {
                const nodeName = node.getAttribute('data-node');
                node.addEventListener('mouseenter', () => {
                    if (selected) return;
                    applyHighlight(nodeName);
                });
                node.addEventListener('mouseleave', () => {
                    if (selected) {
                        applyHighlight(selected);
                    } else {
                        clearHighlight();
                    }
                });
                node.addEventListener('click', () => {
                    if (selected === nodeName) {
                        selected = null;
                        clearHighlight();
                        panel.dispatchEvent(new CustomEvent('nodeCleared'));
                    } else {
                        selected = nodeName;
                        applyHighlight(nodeName);
                        panel.dispatchEvent(new CustomEvent('nodeSelected', { detail: { name: nodeName } }));
                    }
                });
            });
        }

        buildAdjacency(document.getElementById('deployment'), {
            'Cliente': ['Internet'],
            'Internet': ['Cliente', 'Entrada VPC', 'IGW', 'WAF/ALB'],
            'IGW': ['Entrada VPC', 'Internet'],
            'Entrada VPC': ['Internet', 'EC2 App', 'WAF/ALB'],
            'AWS VPC': ['Subred pública', 'Subred privada'],
            'Subred pública': ['EC2 App', 'AWS VPC', 'NAT Gateway'],
            'Subred privada': ['PostgreSQL', 'AWS VPC', 'NAT Gateway'],
            'NAT Gateway': ['Subred privada'],
            'EC2 App': ['Entrada VPC', 'PostgreSQL', '/media', 'Logs', 'S3'],
            'WAF/ALB': ['Internet', 'Entrada VPC', 'EC2 App'],
            '/media': ['EC2 App'],
            'Logs': ['EC2 App'],
            'S3': ['EC2 App'],
            'PostgreSQL': ['EC2 App', 'Subred privada']
        });

        buildAdjacency(document.getElementById('der'), {
            'auth_user': ['Ticket', 'TicketComment', 'TicketAttachment', 'TicketAssignment', 'AuditLog'],
            'Category': ['Subcategory', 'Ticket'],
            'Subcategory': ['Category', 'Ticket'],
            'Ticket': ['auth_user', 'Category', 'Subcategory', 'Priority', 'Area', 'TicketComment', 'TicketAttachment', 'TicketAssignment', 'AuditLog'],
            'Priority': ['Ticket'],
            'Area': ['Ticket'],
            'TicketComment': ['Ticket', 'auth_user'],
            'TicketAttachment': ['Ticket', 'auth_user'],
            'TicketAssignment': ['Ticket', 'auth_user'],
            'AuditLog': ['Ticket', 'auth_user']
        });

        const usecaseSvg = document.getElementById('usecase-svg');
        const usecaseActors = usecaseSvg.querySelectorAll('.actor');
        const usecaseConnectors = usecaseSvg.querySelectorAll('.actor-connector');
        const usecaseGroups = usecaseSvg.querySelectorAll('.usecase-group');
        const usecaseRelations = usecaseSvg.querySelectorAll('.relation-line');

        function resetUsecaseDiagram() {
            usecaseSvg.dataset.state = 'teaser';
            delete usecaseSvg.dataset.activeActor;
            usecaseActors.forEach(actor => actor.classList.remove('active-actor'));
            usecaseConnectors.forEach(connector => connector.classList.remove('active-connector'));
            usecaseGroups.forEach(group => group.classList.remove('highlight'));
            usecaseRelations.forEach(line => line.classList.remove('active-relation'));
        }

        function activateUsecaseActor(actorName) {
            usecaseSvg.dataset.state = 'active';
            usecaseSvg.dataset.activeActor = actorName;

            const activeTargets = new Set();

            usecaseActors.forEach(actor => {
                const name = actor.getAttribute('data-node');
                const isActive = name === actorName;
                actor.classList.toggle('active-actor', isActive);
            });

            usecaseConnectors.forEach(connector => {
                const isActive = connector.getAttribute('data-source') === actorName;
                connector.classList.toggle('active-connector', isActive);
                if (isActive) {
                    activeTargets.add(connector.getAttribute('data-target'));
                }
            });

            const expandedTargets = new Set(activeTargets);

            usecaseRelations.forEach(line => {
                const source = line.getAttribute('data-source');
                const target = line.getAttribute('data-target');
                const relevant = expandedTargets.has(source) || expandedTargets.has(target);
                line.classList.toggle('active-relation', relevant);
                if (relevant) {
                    expandedTargets.add(source);
                    expandedTargets.add(target);
                }
            });

            usecaseGroups.forEach(group => {
                const nodeName = group.getAttribute('data-node');
                group.classList.toggle('highlight', expandedTargets.has(nodeName));
            });
        }

        resetUsecaseDiagram();

        usecaseActors.forEach(actor => {
            actor.addEventListener('click', (event) => {
                event.stopPropagation();
                const actorName = actor.getAttribute('data-node');
                const current = usecaseSvg.dataset.activeActor;
                if (usecaseSvg.dataset.state === 'active' && current === actorName) {
                    resetUsecaseDiagram();
                } else {
                    activateUsecaseActor(actorName);
                }
            });
        });

        usecaseSvg.addEventListener('click', (event) => {
            if (usecaseSvg.dataset.state !== 'active') return;
            if (event.target.closest('.actor') || event.target.closest('.usecase-group') || event.target.closest('.actor-connector') || event.target.closest('.relations-layer')) {
                return;
            }
            resetUsecaseDiagram();
        });
    </script>
</body>
</html>
